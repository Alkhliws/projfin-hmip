
% ----------------------------------------------------------------------- %
% Arquivo: cenarios.tex
% ----------------------------------------------------------------------- %

\chapter{Cenários de Testes}

\section{A Preparação dos Cenários}

\subsection{Cenários Estudados}
Após os estudos bibliográficos sobre o protocolo MIPv6 e a preparação da
Plataforma de Testes para Mobilidade, iniciou-se a etapa de definição e
implementação de cenários de testes.  Esta etapa teve por objetivo  analisar
algumas funcionalidades dos protocolos instalados, demonstrando
desta forma as potencialidades do ambiente desenvolvido.

Para analisar alguns mecanismos dos protocolos e testar os seus modos de
operação, dois cenários base foram definidos: cenário 1, com o MIPv6, e o
cenário 2, com o HMIPv6. Para o primeiro cenário, duas variações foram
realizadas. Na primeira, descrita na figura \ref{f_cenario1}, é testado o modo
de operação por tunelamento bi-direcional do MIPv6, sem a otimização de rota. A
segunda variação testa o modo de operação por otimização de roteamento. O
cenário 2, descrito na figura \ref{f_cenario2}, tem como objetivo verificar
minimamente o funcionamento do HMIPv6 em comunicações onde os nós
correspondentes não executam otimização de roteamento.

Os arquivos para a configuração dos cenários usados no GUML4MIP estão
disponíveis no diretório da documentação do projeto \cite{guml4mip}.

\subsection{Fundamentos para a Análise dos Cenários}
Na análise dos cenários estudados foram focados os seguintes aspectos:
\begin{itemize}
  \item a sequência e a natureza das mensagens trocadas entre os vários nós.
Neste ponto, foram utilizadas as saídas geradas pelo programa \textit{tcpdump};
  \item as tabelas de roteamento e as regras de roteamento analisadas em
situações chave, por exemplo, antes e depois da mobilidade;
  \item os aspectos de desempenho e perdas de pacotes, tendo ciência das
limitações desta análise em um ambiente virtual. Os dados obtidos foram
também confrontados com os resultados esperados através de uma abordagem
analítica;
  \item a criação e a manipulação dos túneis entre o agente domiciliar e o nó
móvel, antes e depois do movimento.
\end{itemize}

\subsection{Considerações sobre o Tempo de latência do \textit{Handover}}
O processo de \textit{handover} acontece quando o nó móvel muda seu ponto de
conexão de uma sub-rede para outra. O tempo de latência envolvido neste processo
\cite{xavier} pode ser dividido em quatro fases:

\begin{enumerate}
\item \textbf{Detecção de Movimento (\textit{TD})}: Em um cenário real, 
representa o tempo do \textit{handover} na camada de enlace até o primeiro
RA. Na plataforma de testes construída não foi simulada a camada enlace e,
portanto, não se pode precisar com a exatidão a latência envolvida no processo.
Porém, para fins de estudo, considerar-se-á o tempo entre a entrega do último
pacote, de alguma conexão, recebido na rede domiciliar ($t0$)e o primeiro RA na
rede visitada ($t1$).

\begin{equation}
 TD = t1 - t0
\label{eq.td}
\end{equation}

\item \textbf{Configuração do CoA (\textit{TA})}: Tempo
entre o primeiro RA e o envio do BU ($t2$).

\begin{equation}
 TA = t2 -t1
 \label{eq.ta}
\end{equation}

\item \textbf{Registro com agente domiciliar (\textit{TR})}: Intervalo de tempo
entre o envio do BU ao agente domiciliar e o recebimento do BA($t3$).

\begin{equation}
 TR = t3 - t2
 \label{eq.tr}
\end{equation}

\item \textbf{Otimização de Roteamento (\textit{TO})}: Intervalo de tempo entre
o envio das mensagens do RRP ($t4$) e o recebimento do BA do nó correspondente.

\begin{equation}
 TO = t4 - t3
 \label{eq.to}
\end{equation}

\end{enumerate}

Obviamente, pode-se estimar o tempo de latência do \textit{handover} com a
seguinte
fórmula:

\begin{equation}
 TH = TD + TA + TR + TO
 \label{eq.th}
\end{equation}

\subsection{Metodologia para Realização dos Cenários}
Nos cenários propostos, o nó móvel inicialmente estará em sua rede domiciliar e
depois irá movimentar-se e visitar outras redes. Durante o procedimento de
movimento, testes serão realizados para a coleta de dados que irão ajudar na
análise do protocolo.

Em um teste, o nó correspondente começa a enviar mensagens ICMPv6, por meio do
\textit{ping6}, para o nó móvel:
\begin{verbatim}
cn# ping6 mn
\end{verbatim}

O nó móvel executa o \textit{tcpdump} em modo \textit{verbose} (-vvv) para
realizar o monitoramento da troca de mensagens do funcionamento do MIPv6 durante
o processo de \textit{handover}:
\begin{verbatim}
mn# tcpdump -vvv
\end{verbatim}

Outro procedimento de teste, que é eventualmente realizado durante a execução
dos cenári-os, é uma conexão utilizando o protocolo da camada transporte TCP.
Tal teste visa comprovar a transparência do processo de
mobilidade para as camadas superiores à de rede, além de permitir gerar um
fluxo de dados maior do que com as mensagens ICMPv6 e de possibilitar
uma melhor observação do impacto do protocolo MIPv6 sobre as conexões.

Para realização do teste é iniciado, no nó móvel, um servidor TCP. Este 
servidor responde a requisição GET do protocolo \ac{HTTP}, além de ser capaz de
gerar
tráfego. Para realizar esta tarrefa é utilizado a ferramenta \textit{netcat6},
da forma:
\begin{verbatim}
mn# echo "200 OK" > header; cat header /dev/zero | nc6 -l -p 80
\end{verbatim}

Esta linha significa:
\begin{description}
 \item[echo ``200 OK'' $>$ header:] cria um cabeçalho HTTP com a mensagem ``200 
OK'', para responder as requisições ao servidor;
 \item[nc6 -l -p 80:] inicia um soquete TCP que (-l) escuta a (-p 80) porta 80;
 \item[cat header /dev/zero:] concatena para a entrada padrão do servidor o
arquivo contendo a mensagem HTTP e o dispositivo caracter /dev/zero que é
responsável por gerar o tráfego.
 \end{description}

O nó correspondente irá se conectar ao servidor utilizando da ferramenta 
\textit{wget}. Também no nó correpodente executamos a ferramenta 
\textit{speedometer} que é capaz de medir a taxa média de dados de uma interface
de rede. A saída do \textit{speedometer} permite criar um gráfico para
visualizar o efeito do MIPv6 em uma conexão.

\begin{verbatim}
cn# wget -6 --limit-rate=1M http://mn -o /dev/null -O /dev/null &
cn# speedometer -p -i 0.1 -rx eth0
\end{verbatim}

Sobre os comandos executados no nó correspondente as seguintes considerações:
\begin{itemize}
 \item O gerador produz uma taxa muito elevada de dados o
que ocasiona o travamento das máquinas virtuais. Para resolver este problema a
taxa é limitada (--limit-rate=1M) para 1MBps;
 \item o \textit{speedtometer} vai monitorar a recepção da interface
eth0 em intervalos de 0.1 segundos.
\end{itemize}

\subsection{Subsídios para interpretação dos pacotes IPv6 no tcpdump}

Nas listagens do \textit{tcpdump}, utilizadas na seções que se seguem, os
pacotes serão
mostrados da seguinte forma:

$<$estampa\_tempo$>$ IP6 ( .. next header $<$tipo\_next\_header$>$ ..)
$<$endereço\_fonte$>$ \\ $<$endereço\_destino$>$

No caso de túneis, onde existe encapsulamento de IP sobre IP, o formato é
repetido e o campo \textit{next header} do primeiro nível indica que o próximo
cabeçalho é um pacote IPv6. No segundo nível, o \textit{next header} é a carga
original transportada, por exemplo, um pacote ICMP6:

$<$estampa\_tempo$>$ IP6 ( .. next header IPv6 ..) 
        $<$endereço\_fonte$>$ $<$endereço\_destino$>$
        IP6 ( .. next header ICMP6 ..) 
        $<$endereço\_fonte$>$ $<$endereço\_destino$>$

É interessante lembrar que os RA são mensagens ICMP6, assim
como os \textit{echo-request} e \textit{echo-reply} produzidos pelo ping.

O \textit{tcmpdump} apresenta os cabeçalhos de mobilidade (BU e BA) com
\textit{next-header
unknown} no caso do BU e de \textit{source routing} no caso do BA. Entretanto, o
\textit{next-header} é detalhado na sequência mostrando o tipo e eventualmente o
DSTOPT (campo \textit{destination option}).


\section{Cenário 1 - Uso do Protocolo MIPv6}
\label{s_cenario1}

\subsection{Descrição da Topologia}
O primeiro cenário de teste é formado por três redes interligadas entre si e
cinco nós. A sua topologia pode ser observada na figura \ref{f_cenario1}, onde o
numero nos balões cinza representam a VLAN no \textit{uml\_switch}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.4]{figs/cenario1}
	\caption{Topologia do Cenário 1}
	\label{f_cenario1}
\end{figure}

Na rede com prefixo 2000:a::/64 está o nó correspondente, com quem o nó móvel
está se comunicando. Na rede com o prefixo 2000:c::/64 está presente um roteador
(HA) que oferece o serviço de agente domiciliar ao nó móvel. A rede com prefixo
2000:d::/64 é a rede que o nó móvel deve visitar.

\subsection{Variação 1: com Tunelamento Bidirecional e Sem Otimização de Rota}

\subsubsection{Análise da Troca de Mesagens}
Os dados obtidos na saída do comando \textit{tcpdump} podem ser observados na
figura \ref{f_dump_1}. Analisando os dados recolhidos consegue-se observar:

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/dump1}
	\caption{Cenário 1 : Captura de mensagens com Tunelamento Bidirecional}
 	\label{f_dump_1}
\end{figure}

\begin{enumerate}
 \item O nó móvel recebe uma mensagem de RA do
roteador de acesso da rede visitada (src = fe80::fcfd:71ff:febf:e3e1), o que
indica que ocorreu mobilidade. Este movimento foi produzido pela comutação
da vlan 3 para a 4. Antes de realizar o movimento o nó móvel recebia
\textit{echo request} do nó correspondente (src = 2001:a::fcfd:65ff:fe34:8a44) e
RA do Agente domiciliar (src = fe80::fcfd:f5ff:fe49:32bc);
 \item O nó móvel realiza o teste de duplicaçãoo de endereco (DAD) do CoA gerado
com o prefixo da rede visitada (2001:d::fcfd:32ff:feff:42c9);
 \item O nó móvel envia a mensagem de BU para o agente Domiciliar informando o
endereço CoA e o seu endereço domiciliar HoA. Note que o CoA é o endereço fonte
do pacote e o HoA é informado na opção DSTOPT;
 \item O agente domiciliar envia um BA, confirmando o registro;
 \item O nó móvel volta a receber \textit{echo request} do nó correspondente,
só que agora através do túnel. Note os endereços IP fonte e destinos deste
pacote. O primeiro nível IP do agente domiciliar(2001:c::1) para o CoA do nó
móvel (2001:d::fcfd:32ff:feff:42c9). No segundo nível, do nó correspondente
(2001:a::fcfd:65ff:fe34:8a44) para o HoA (2001:c::2).

\end{enumerate}

\subsubsection{Análise das Tabelas de Roteamento e de Regras de Roteamento}

Após o nó móvel deixar a rede domiciliar, podemos constatar mudanças nas tabelas
de roteamento do nó móvel e do agente domiciliar, que são mostradas nas 
respecitivas tabelas \ref{t_rot_mn1} e \ref{t_rot_ha1}.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
 salto} & \textbf{Considerações} \\ \hline \hline
2001:a::/64 &	eth0	&	fe80::fcfd:dff:fe0c:a222 & \\
2001:b::/64 &   eth0	&	::  & \\
\textbf{2001:c::2} & \textbf{eth1} & \textbf{2001:c::2}  & Antes da mobilidade
do nó móvel\\
2001:c::/64 &	eth1	&	::  & \\
2001:d::/64 &	eth0	&	fe80::fcfd:9fff:fe3d:cf8a  & \\ \hline
2001:a::/64 &	eth0	&	fe80::fcfd:dff:fe0c:a222  & \\
2001:b::/64 &	eth0	&	::  & \\
\textbf{2001:c::2} & \textbf{ip6tnl1} & \textbf{2001:c::2} & Após a mobilidade
do nó móvel \\
2001:c::/64 &	eth1	&	::  & \\
2001:d::/64 &	eth0	&	fe80::fcfd:9fff:fe3d:cf8a  & \\ \hline
\end{tabular}
\end{small}
\caption{Tabela principal de roteamento do agente domiciliar}
\label{t_rot_ha1}
\end{table}

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto} & \textbf{Considerações}\\ \hline \hline
2001:c::2	          & ip6tnl1		  & :: &  \\
2001:c::/64               & eth0		  & :: & Na rede domiciliar \\
default	                  & eth0		  & fe80::fcfd:f5ff:fe49:32bc &
\\ \hline
2001:c::2	          & ip6tnl1		  & :: &  \\
2001:d::/64               & eth0		  & :: & Na rede visitada \\
default		          & eth0	          & fe80::fcfd:71ff:febf:e3e1 &
\\ \hline
\end{tabular} 
\end{small}
\caption{Tabela principal de roteamento do nó móvel}
\label{t_rot_mn1}
\end{table} 

Após o agente domiciliar receber o \textit{Binding Update},
é adicionada a seguinte rota a sua tabela de roteamento, que todos os 
pacotes com destino ao endereço domiciliar devem ser encaminhados para o túnel.
Após o nó móvel receber o \textit{Router Advertisement}, é alterada a rota
padrão, deletada a rota para rede 2001:c::/64 e adicionada uma rota para a rede 
2001:d::/64, onde a interface eth0 está atrelada.

Para que o nó móvel tenha os pacotes com destino ao nó correspondente e ao 
agente domiciliar encaminhados pelo túnel, o que caracteriza o tunelamento
bidirecional, é adicionada regras na tabela 252, mostradas na tabela
\ref{t_route_252_mn}.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto} & \textbf{Considerações}\\ \hline \hline
          *                 &   *     &     *     &  Na rede domiciliar\\ \hline
2001:a::fcfd:65ff:fe34:8a44 & ip6tnl1 & 2001:a::fcfd:65ff:fe34:8a44 & \\
2001:c::1                   & ip6tnl1 & 2001:c::1 &  Na rede visitada\\
default                     & ip6tnl1 & ::        & \\ \hline
\end{tabular} 
\end{small}
\caption{Tabela de Roteamento 252 do nó móvel}
\label{t_route_252_mn}
\end{table}

No agente domiciliar é adicionada uma rota na tabela 252, para que os pacotes 
capturados com destino ao nó móvel e origem no agente domiciliar.


\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Origem} & \textbf{Via} & \textbf{Considerações}\\
 \hline \hline
2001:c::2 & 2001:c::1 & eth1 & Após a mobilidade do nó móvel \\ \hline
\end{tabular}
\end{small}
\caption{Tabela de Roteamento 252 do agente domiciliar}
\label{t_route_252_ha}
\end{table}

Como existe mais de uma tabela de roteamento, para fazer a seleção de qual 
tabela é mais adequada para encaminhar determinado pacote, é determinado
regras de roteamento. O MIPv6 adiciona um regra direcionando para tabela 252,
no nó móvel e no agente domiciliar, mostradas nas tabelas \ref{t_rule_mn} e 
\ref{t_rule_mn}, respectivamente.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c||}\hline \hline
\textbf{Prioridade} & \textbf{Regra} & \textbf{Ação}
\\ \hline \hline
0:	& from all        &  lookup local \\
\textbf{1001}:	& \textbf{from 2001:c::2}  &  \textbf{lookup 252} \\
1002:	& from fe80::/64 &   lookup main \\
1002:	& from 2001:d::/64 & lookup main \\
1003:	& from 2001:c::2  &  blackhole \\
32766:	& from all        &  lookup main \\ \hline
\end{tabular} 
\end{small}
\caption{Regras de Roteamento do Nó movel}
\label{t_rule_mn}
\end{table} 

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c||}\hline \hline
\textbf{Prioridade} & \textbf{Regra} & \textbf{Ação}
\\ \hline \hline
0:	& from all        &  lookup local \\
\textbf{1005}:	& \textbf{from 2001:c::2 } &  \textbf{lookup 252} \\
32766:	& from all        &  lookup main \\ \hline
\end{tabular} 
\end{small}
\caption{Regras de Roteamento do Home Agente}
\label{t_rule_ha}
\end{table} 

\subsubsection{Detalhes da Formação de Túneis}
O túnel no nó móvel é criado antes de acontecer qualquer mobilidade. No agente
domiciliar o  túnel com o nó móvel é criado no recebimento do BU. As tabelas 
\ref{t_tun_ha1} e \ref{t_tun_mn1} apresentam o endereçamento do tunel, no HA e 
MN, antes e depois da mobilidade.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} & \textbf{Considerações} \\ \hline \hline
ip6tnl1 & 2001:c::1 & 2001:c::2 & eth0 & Antes da mobilidade do nó móvel \\
 \hline
ip6tnl1 & 2001:c::1 & 2001:d::fcfd:32ff:feff:42c9 & eth0 & Após a mobilidade do 
nó móvel \\ \hline
\end{tabular}
\end{small}
\caption{Descrição dos \texttt{end-points} do tunel do nó móvel}
\label{t_tun_mn1}
\end{table}

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} & \textbf{Considerações} \\ \hline \hline
*  & * & * & * & Antes da mobilidade do nó móvel \\ \hline
ip6tnl1 & 2001:d::fcfd:32ff:feff:42c9 & 2001:c::1 & eth0 & Após a mobilidade do 
nó móvel \\ \hline
\end{tabular}
\end{small}
\caption{Descrição dos \texttt{end-points} do tunel do agente domiciliar}
\label{t_tun_ha1}
\end{table}

%===========================================================================
\subsection{Variação 2: MIPv6 com Otimização de Rota}

\subsubsection{Análise da Troca de Mensagens}

Os dados obtidos na saída do comando \textit{tcpdump} podem ser observados na
figura \ref{f_dump_2}. Analisando os dados recolhidos consegue-se observar:

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/dump2}
	\caption{Cenário 1 : Captura de mensagens com Otimização de Rota}
 	\label{f_dump_2}
\end{figure}

\begin{enumerate}
%1
 \item O nó móvel recebe uma mensagem de RA do 
roteador de acesso da rede visitada, o que indica que ocorreu mobilidade. Antes 
de realizar o movimento o nó móvel respondia um \textit{echo request} do nó 
correspondente;
%2
 \item O nó móvel realiza o teste de duplicacao de endereco (DAD) do CoA gerado
com o prefixo da rede visitada (2001:d::fcfd:32ff:feff:42c9);
%3
 \item O nó móvel a mensagem de BU para o Agente domiciliar informando o atual 
endereço. Note que o CoA é o endereço fonte do pacote e o HoA é informado na 
opção DSTOPT;
%4
 \item O agente domiciliar envia um BA, confirmando o registro;
%5
 \item O nó movel volta a receber \textit{echo request} do nó correspondente,
só que ainda através do túnel. A otimização de rota só irá ocorrer após o
processo de RRP. Note os endereços IP fonte e destinos
deste pacote. O primeiro nível IP do agente domiciliar(2001:c::1) para nó móvel
(2001:d::fcfd:32ff:feff:42c9). No segundo nível, do nó correspondente
(2001:a::fcfd:65ff:fe34:8a44).
%6
 \item O nó móvel inicia o processo de \textit{ruturn routability} enviando
via agente domiciliar a mensagem de \textit{Home Test Init}(HoTi) ao nó 
correspondente, para adiquirir a \textit{home keygen token}.
%7
 \item O nó móvel recebe a mensagem de \textit{Home Test}(HoT) do nó
correspondente, via agente domiciliar.
%8
 \item O nó móvel da continuação ao processo de \textit{ruturn routability}
enviando a mensagem de \textit{Care-of Test Init}(CoTi) ao nó correspondente,
para adiquirir a \textit{care-of keygen token}. Essa menssagem não passa pelo 
tunel, ela é endereçada diretamente ao nó correspondente.
%9
 \item O nó móvel recebe a mensagem de \textit{Care-of Test}(CoT) do nó 
correspondente, não passando pelo agente domiciliar.
%10
 \item O nó móvel envia um \textit{Binding Update} ao nó correspondente com o
\textit{binding management key}(kbm), concluindo o processo de 
\textit{return routability}.
%11
 \item O nó móvel recebe uma mensagem de \textit{echo request}, endereçada ao 
CoA, não passando mais pelo agente domiciliar. Note que a opção DSTOPT que trás
o endereço domiciliar (2001:c::2) do nó móvel.

\end{enumerate}

\subsubsection{Estado das Tabelas de Roteamento e de Regras}
Sobre as tabelas e as regras de roteamento, quando o nó móvel e o nó 
correspondente estão configurados para realizar a otimização de rota, não existe
nenhuma alteração em relação a variação 1.

\subsubsection{Detalhes da Formação de Túneis}
Sobre os tuneis, não há nenhuma alteração em relacão ao cenário configurado com
tunelamento bidirecional sem otimização de rota.

%=========================================================================

\section{Cenário 2 - Uso do Protocolo HMIPv6}
\label{s_cenario2}

\subsection{Descrição da Topologia}
Com o fim de testar se a implementação experimental do HMIPv6 atende as
funcionalidades do protocolo, o cenário 2 foi montando com os seguintes 
componentes (ver figura \ref{f_cenario2}):

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.3]{figs/cenario2}
	\caption{Topologia do Cenário 2}
 	\label{f_cenario2}
\end{figure}

\begin{itemize}
 \item Rede domiciliar com o prefixo 2001:d::/64 (VLAN 4), onde estão o
agente domiciliar (HA) e o nó móvel (MN), no início do teste;
 \item Rede com o prefixo 2001:a::/64 (VLAN 1), onde estão presentes um
roteador de acesso (AR1) e o nó correspondente (CN). Este último irá se
comunicar com o nó móvel durante o teste;
 \item Um domínio formado pelo roteador MAP, que executa o \textit{daemon} MIPL
na
função de agente domiciliar, e dois roteadores de acesso (AR2 e AR3), que
possibilitam o teste de mobilidade em um mesmo domínio. Fazem parte
deste domínio as sub-redes com os prefixos: 2001:c::/64 (VLAN 3),
2001:e::/64 (VLAN 5) e 2001:f::/64 (VLAN 6).
\end{itemize}

Durante a execução do cenário:
\begin{enumerate}
 \item O nó móvel iniciará na rede domiciliar se comunicando via \textit{ping6}
com o nó correspondente.
 \item Uma situação de mobilidade será ocasionada e o nó irá migrar para a
VLAN 5, domínio do MAP, caracterizando uma mobilidade global.
 \item Na segunda situação de mobilidade o nó irá migrar para a VLAN 6
caracterizando uma mobilidade local.
\end{enumerate}

\subsection{Análise da Troca de Mensagens}

\subsubsection{Mobilidade Global}
Durante a primeira situação de mobilidade do cenário 2, uma mobilidade global,
os dados coletados com a ferramenta \textit{tcpdump} estão disponíveis na figura
\ref{f_dump_inter}. Por meio deles pode-se observar que:

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.55]{figs/dump_inter}
	\caption{Cenário 2: \textit{Logs} Mobilidade Global}
 	\label{f_dump_inter}
\end{figure}

\begin{enumerate}
 \item Inicialmente o nó móvel está na sua rede domiciliar recebendo 
\textit{echo request}s do nó correspondente e mensagens RA do
agente domiciliar. Pode-se evidenciar este fato pelo campo
src=fe80::fcfd:f5ff:fe49:32bc do RA que é o endereço link local do agente
domiciliar. A mensagem 1 evidencia a mobilidade do nó móvel pois ele passa a
receber mensagens RA do roteador de acesso AR2 (src=fe80::fcfd:71ff:febf:e3e1,
endereço link local de AR2) com a opção de MAP propagada pelo roteador MAP.
Esta opção não é mostrada pelo tcpdump. Com este RA o nó móvel forma os
endereços LCoA(2001:e::fcfd:32ff:feff:42c9) e RCoA(2001:e::fcfd:32ff:feff:42c9);
 \item O nó móvel realiza o DAD do LCoA
gerado com o prefixo da rede visitada (endereço fe80::fcfd:32ff:feff:42c9); 
 \item O nó móvel envia a mensagem de BU para o MAP (dst=2001:c::1) informando a
dupla
(LCoA,RCoA). Note que LCoA é o  endereço fonte do pacote e o RCoA é informado
na opção DSTOPT;
\item O nó móvel envia a mensagem de BU para o Agente Domiciliar (dst=2001:d::1)
informando a dupla (RCoA,HoA). Note que RCoA é o endereço fonte do pacote e o
HoA é informado na opção DSTOPT;
 \item O nó móvel recebe a mensagem de BA do MAP como confirmação de registro
bem sucedido;
 \item O nó móvel recebe a mensagem de BA do agente domiciliar, como confirmação
de registro bem sucedido, via MAP, de forma tunelada. Note no primeiro nível os
endereços IP do MAP (2001:d::1) e IP LCoA (2001:e::fcfd:32ff:feff:42c9). Na
sequência também chega um pacote provindo do nó correspondente que, embora
não explícito pelo \textit{tcpdump}, provavelmente pertence a um \textit{echo
request}
duplamente tunelado. Note os endereços IPs fonte e destino destes pacotes: no
primeiro nível IP do MAP para IP LCoA e, no segundo nível, IP do
Agente domiciliar para IP RCoA;
 \item Envia um \textit{echo reply} ao nó correspondente, com destino ao agente
domiciliar, com a mensagem tunelada ao nó correspondente, via MAP.
\end{enumerate}

\subsubsection{Mobilidade Local}
Na segunda situação de mobilidade do cenário 2, uma mobilidade local, as
mensagens trocadas pelo nó móvel estão disponíveis na figura \ref{f_dump_intra}.
Por meio delas pode-se observar que:

\begin{enumerate}
 \item É realizada a mobilidade e passa receber mensagens RA do roteador de
acesso AR3 ainda sobre cobertura do mesmo MAP.
 \item Realiza o DAD do novo LCoA gerado.
 \item Envia a mensagem de BU para o MAP com os seguintes campos:
\begin{itemize}
 \item Care-of-Address = LCoA;
 \item Endereço domiciliar = RCoA, gerado a partir da opção de MAP da mensagem
RA.
\end{itemize}
 Como é uma mobilidade local não é necessário enviar mensagem ao agente 
domiciliar.
 \item Recebe a mensagem de BA do MAP como confirmação de registro bem
sucedido.
 \item Recebe um \textit{echo reply} do nó correspondente, via MAP com a 
mensagem tunelada do agente domiciliar.
\end{enumerate}
\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.55]{figs/dump_intra}
	\caption{Cenário 2: \textit{Logs} Mobilidade Local}
 	\label{f_dump_intra}
\end{figure}

\subsection{Estado das Tabelas de Roteamento e de Regras}
Sobre as tabelas e as regras de roteamento, a implementação do HMIpv6 não faz
nenhuma alteração. As tabelas de roteamento do cenário 2 se diferem muito pouco
das do cenário 1, tanto na mobilidade global como na local. As tabelas 252
(\ref{t_c2_route_252}) e a principal (\ref{t_c2_route_main}), após a primeira
situação de mobilidade estão disponíveis logo abaixo. E seguem algumas
considerações sobre as regras e tabelas de roteamento do cenário 2:

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto}\\ \hline \hline
2001:a::fcfd:65ff:fe34:8a44 & ip6tnl1 & 2001:a::fcfd:65ff:fe34:8a44 \\
2001:d::1                   & ip6tnl1 & 2001:d::1\\
default                     & ip6tnl1 & :: \\ \hline
\end{tabular} 
\end{small}
\caption{Cenário 2: Tabela de Roteamento 252}
\label{t_c2_route_252}
\end{table}


\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto} \\ \hline \hline
2001:d::fcfd:32ff:feff:42c9 & ip6tnl2		  & :: \\
2001:e::2	          & ip6tnl1		  & :: \\
2001:10::/64              & eth0		  & :: \\
default		          & eth0	          & fe80::fcfd:53ff:fe16:31aa \\
\hline
\end{tabular} 
\end{small}
\caption{Cenário 2: Tabela principal de roteamento}
\label{t_c2_route_main}
\end{table} 

\begin{itemize}
 \item antes da primeira situação de mobilidade, as tabelas e regras de
roteamento do cenário 2 são iguais as cenário 1 antes da mobilidade;
 \item após a mobilidade:
\begin{itemize}
 \item as regras de roteamento são as mesmas que as do cenário com MIPv6;
 \item a tabela 252 se mantém a mesma que a do cenário com MIPv6.
 \item a rota padrão é alterada para o roteador de acesso AR3 e depois na
segunda situação de mobilidade para o roteador AR4;
 \item adicionada a rota que pacotes com destino ao RCoA são via ip6tnl2;
 \item as outras rotas se mantém as mesmas que as de um cenário com MIPv6.
\end{itemize}
\end{itemize}

\subsection{Detalhes da Formação de Túneis}
Os detalhes da formação dos túneis do cenário 2 diferem um pouco do cenário 1 a
implementação do HMIPv6 é a responsável. Nas tabelas \ref{t_tun_inter} e
\ref{t_tun_intra} é possível ver os túneis presentes no nó móvel após as
mobilidades global e local. As principais diferenças do cenário 1 são:

\begin{itemize}
 \item a criação do túnel (ip6tnl2) entre o LCoA do nó móvel 
(2001:e::fcfd:32ff:feff:42c9) e o MAP (2001:c::1). Este túnel é necessário, pois
os pacotes oriundos do Agente domiciliar serão endereçados agora ao
RCoA(2001:c::fcfd:32ff:feff:42c9). Como há no MAP um registro do LCoA-RCOA, este
túnel passa a encaminhar os pacotes do HA ao nó móvel;
 \item para que os pacotes vindos via MAP destinados ao endereço domiciliar 
(2001:d::2) sejam entregues ao nó móvel é necessário a alteração dos pontos
finais do túnel entre o nó móvel e o Agente domiciliar, para o RCoA e o endereço
do agente domciliar, e a interface que este túnel está ligado agora deve ser o
outro túnel criado entre nó móvel e o MAP.
\end{itemize}

Os túneis dos MAP e agente domiciliar se mantém iguais aos de um cenário
rodando o MIPv6.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} \\ \hline \hline
ip6tnl1 & 2001:d::1 & 2001:c::fcfd:32ff:feff:42c9 & ip6tnl2 \\
 \hline
ip6tnl2 & 2001:c::1 & 2001:e::fcfd:32ff:feff:42c9 & eth0  \\ \hline
\end{tabular}
\end{small}
\caption{Cenário 2: Túneis Mobilidade Global}
\label{t_tun_inter}
\end{table}

Após a mobilidade local verificamos que os dois túneis (ver \ref{t_tun_intra})
continuam presentes no nó móvel. Porém, o ponto local do túnel \textit{ip6tnl2}
foi alterado para o novo LCoA (2001:f::fcfd:32ff:feff:42c9) gerado na sub-rede
do AR3.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} \\ \hline \hline
ip6tnl1 & 2001:d::1 & 2001:c::fcfd:32ff:feff:42c9 & ip6tnl2 \\
 \hline
ip6tnl2 & 2001:c::1 & 2001:f::fcfd:32ff:feff:42c9 & eth0  \\ \hline
\end{tabular}
\end{small}
\caption{Cenário 2: Túneis Mobilidade Local}
\label{t_tun_intra}
\end{table}

\section{Análise dos Tempos de \textit{Handover}}
O tempo do handover é um dos maiores problemas do MIPv6, esta seção do trabalho
pretende fazer uma análise deste processo apontar as causas e possíveis
soluções. Como base para estudo dos tempos de \textit{handover} o cenário 1 com
tunelamento bidirecional foi utilizado.

Para verificar a perda na taxa de transmissão em um processo de
\textit{handover}, foi realizado o segundo teste especificado na seção sobre a
metodologia na realização dos cenários. Utilizando a ferramenta \textit{GNUPLOT}
com a saída do teste foi gerado o gráfico que pode ser observado na figura
\ref{f_banda}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/banda}
	\caption{Taxa de transmissão em \textit{Handover}}
	\label{f_banda}
\end{figure}

A partir  da figura é possível concluir que cada \textit{handover} é de
aproximadamente 3 segundos, há perdas consideráveis de pacotes que prejudicariam
muito comunicações interativas como videoconferência e \textit{VoIP}, porém,
navegação em páginas da \textit{Internet} e visualização de \textit{e-mail} a
instabilidade é tolerável.

Como cenário estudo foi simulado todos os tempos medidos são estimados. Porém,
segundo algumas bibliografias estudadas que realizaram experimentos fisicamente
os tempos medidos na simulação estão dentro do esperado.

Na tabela \ref{t_handover}, encontram-se os tempos das fases do processo de
\textit{handover} referentes ao cenário estudado.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|}\hline
\textbf{Fase} & \textbf{Tempo (ms)} & \textbf{Media
\%} \\ \hline
\textit{TD} & 721 & 23,11 \\ \hline
\textit{TA} & 1371 & 43.92\\ \hline
\textit{TR} & 1029 & 32.97\\ \hline
\textit{TH} & 3121 & 100 \\ \hline
\end{tabular} 
\end{small}
\caption{Latência no \textit{Handover} do cenário estudado}
\label{t_handover}
\end{table} 

Algumas tentativas podem ser feitas para tentar diminuir a latência do
\textit{handover} nas fases de detecção de movimento e de configuração do
CoA.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/radvd}
	\caption{Diferentes intervalos entre as mensagens \textit{Router
Advertisement}}
	\label{f_radvd}
\end{figure}

Na tentativa de diminuir o tempo da fase de detecção de movimento, podemos
diminuir o intervalo entre as mensagens de RA do
roteador presente na rede que irá ser visitada pelo nó móvel. Pois, é por meio
desta mensagem que o nó móvel detecta o movimento e desencadeia o processo de
registro.

Para verificar se há uma melhora no processo de handover. O cenário
estudado foi repetido variando o intervalo entre as mensagens de
\textit{Router Advertisement}. O resultado deste teste esta disponível na figura
\ref{f_radvd}.

Com os dados levantados, é possível perceber que o intervalo entre as
mensagens de RA esta diretamente ligado com a perda
de pacotes durante o \textit{handover}. Porém, esta não é uma boa prática para
tentar amenizar a latência do handover, pois um numero muito grande de mensagen
\textit{multicasting} inundaria a rede prejudicando a perfomance principalmente
em redes sem fio.

No processo de formação de um novo CoA o DAD é necessário
para se certificar que o endereço formado é exclusivo. Para o teste ser bem
sucedido nenhum nó vizinho deve enviar um \ac{NA}, em
resposta ao teste, ou NS, como o mesmo endereço em
questão, em um período de \textit{1000ms} segundo a RFC 2462 \cite{rfc2462}.
Este tempo de espera compromete a fase de configuração do CoA.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/banda2}
	\caption{Taxa de transmissão em \textit{Handover} sem DAD e baixo
intervalo de RA}
	\label{f_banda2}
\end{figure}

Existe uma variável chamada \textit{dad\_transmits} no \textit{kernel} do Linux
que é usada para configurar o DAD em um nó. Com a intenção de diminuir a
latência na fase de configuração do CoA, foi configurado a
variável com o valor 0, isso significa que o procedimento de DAD é cancelado, e
foi alterado o valor do intervalo das mensagens de RA
no roteador de acesso da rede visitada para 0.03 segundos. Então foi repetido o
teste. O resultado pode ser observado na figura \ref{f_banda2}.

Apartir, deste teste é possível perceber uma queda de 3 segundos para
aproximadamente 1 segundo no tempo do \textit{handover} com as mudanças
realizadas. Entretanto há um protocolo dedicado a acelerar o processo de
handover o \ac{FMIPv6}. A idéia do FMIPv6 é providenciar
informação relativa à camada de rede, com o objetivo de prever ou responder
prontamente a um evento de handover \cite{rfc4068}.

\section{Conclusões sobre a Análise dos Cenários}
Com a realização dos experimentos podemos constatar o funcionamento do protocolo
e perceber continuação da comunicação entre os pontos comunicantes após a
mobilidade de forma transparente as camadas superiores a de rede, observar todas
as mensagens trocadas no processo e estimar o tempo de latência com a
mobilidade.

O primeiro resultado que se pode obter com a realização do Cenário 1, foi o
perfeito funcionamento do MIPv6, ocorreram algumas perdas de pacotes, mas o nó
móvel conseguiu continuar sendo alcançado pelo seu endereço domiciliar mesmo não
estando em sua rede domiciliar.

Na realização do segundo cenário, foi possível verificar minimamente o
funcionamento
do HMIPv6, claro que os problemas ainda existentes na implementação não
permitiram comprovar uma melhora no \textit{handover}. Porém, pode-se ver um
avanço já que não tinhamos nenhuma versão recente deste protocolo.

Com a realização dos cenários é possível verificar que o \textit{handover} é o
é o grande problema MIPv6, por isso, a necessidade de outras extensões para
trabalharem juntos com o MIPv6 como: o HMIPv6 e FMIPv6.