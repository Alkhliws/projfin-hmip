% ----------------------------------------------------------------------- %
% Arquivo: plataformadetestes.tex
% ----------------------------------------------------------------------- 

\chapter{Plataforma de Testes para Mobilidade em Redes IP}
\label{c_plataforma}

\section{Descrição Geral da Plataforma}
\label{s_plataforma_intro}

A plataforma desenvolvida neste trabalho tem como objetivo prover o usuário com:
\begin{itemize}
 \item um sistema que permita facilidades no estudo dos protocolos de
mobilidade da camada de rede, em particular o MIPv6 e HMIPv6. Outros protocolos
poderão ser instalados no futuro;
 \item facilidades para a rápida construção de cenários de rede, sem se ater a
procedimentos de configuração e instalação de equipamentos de rede sem fio;
\item facilidades para a rápida instalação da plataforma nas máquinas
hospedeiras.
\end{itemize}

Na concepção da plataforma de testes, optou-se por utilizar um ambiente baseado
em máquinas virtuais devido a rapidez na realização de experimentos: em somente
uma máquina de hospedagem é possível o desenvolvimento, análise e testes de
protocolos de rede. Além disto, existem vantagens econômicas e de redução de
complexidade, pois não há necessidade de diversos equipamentos para a realização
dos experimentos.

Em geral, uma plataforma de testes de mobilidade envolve o uso de redes sem fio.
No entanto, como o objetivo principal da plataforma é possibilitar o estudo de
protocolos de camada 3, decidiu-se por construir um ambiente de teste através de
máquinas virtuais \ac{UML} \cite{dike2009uml}
adaptando os \textit{switches} virtuais para produzir a mobilidade. Desta forma,
evita-se a complexidade adicional de instalação de hardware para a rede sem
fio.

Os seguintes componentes podem ser identificados nesta plataforma:
\begin{itemize}
 \item máquinas e \textit{switches} virtuais UML para construção de domínios e
dos nós móveis. Os \textit{switches} virtuais foram modificados para a simulação
de mobilidade;
\item Interface gráfica para permitir a rápida construção de cenários e para
possibilitar o comando de mobilidade;
\item Ferramentas para estudo dos protocolos: gerador de tráfego, medidor de
banda e de perda de pacotes;
\item Protocolos de Mobilidade da Camada 3: instalação, nas \acp{UML}, de uma 
versão do MIPv6, do gerador de mensagens de advertência de roteador
do IPv6 \ac{RADVD} e de uma versão do HMIPv6. Como será visto adiante, não
existe uma versão atualizada do protocolo HMIPv6. Parte do trabalho foi dedicada
a uma extensão do MIPv6 para o HMIPv6;
\item Outros protocolos e ferramentas de apoio: alguns protocolos e
ferramentas adicionais foram instalados, tais como o protocolos RIP e o
protocolo OSPF, através do pacote Zebra \cite{quagga}.
\end{itemize}

Na sequência, apresentamos alguns detalhes sobre os componentes da plataforma
sendo que os aspectos relacionados aos protocolos de mobilidades serão
discutidos separadamente nos próximos capítulos.


\section{A UML como Bloco Básico da Plataforma de Testes}

\subsection{UML - \textit{Linux} em Modo Usuário}
\label{s_plataforma_uml}

A máquina virtual UML foi escolhida como base para a construção das redes 
virtuais na plataforma de testes. Ela oferece várias possibilidades de
construção de redes, além de ser incorporada ao \textit{kernel} do Linux e de
apresentar um alto desempenho na execução de programas. Isto permite iniciar
múltiplas instâncias UML em uma mesma máquina hospedeira e a construção de
complexos cenários de rede.

O Linux executa a máquina UML como um processo comum no sistema. O processo é
executado em um ambiente isolado protegendo a camada física da máquina
hospedeira, o que não impõe restrições de uso para a máquina virtual, tornando
um ambiente excelente para testes \cite{luruo2005vnu}. A figura
\ref{f_plataforma_uml} mostra o funcionamento da UML em uma máquina hospedeira.

\begin{figure}[!htpb]
    \centering
    \includegraphics[scale=1]{figs/uml}
    \caption{Funcionamento do Linux em Modo Usuário}
    \label{f_plataforma_uml}
\end{figure}

É comum chamar a UML de máquina virtual, porém, a tecnologia de virtualização
UML constitue-se, na verdade, em um sistema operacional virtual. O termo
máquina virtual seria mais aplicável em tecnologias de virtualização tal como a
\textit{VMWare}, onde realmente é emulada uma plataforma
física, processador e periféricos, sendo que o sistema operacional é executado
nesta plataforma emulada.

A UML permite construir sistemas que em um ambiente real seriam muito difíceis
de reproduzir, por exemplo, é possível criar uma máquina com \textit{n}
interfaces de rede e discos. Devido a sua flexibilidade, a UML pode ser
utilizada para inúmeras aplicações tais como:
\begin{itemize}
 \item Consolidação de servidores de rede: é possível reproduzir todo sistema em
UML e testá-lo antes de colocá-lo em produção;
 \item Em ambientes de ensino: com UML os alunos podem desenvolver as atividades
ensinadas sem a preocupação de danificar o sistema;
 \item No desenvolvimento de aplicações em nível usuário, protocolos de rede, do
\textit{kernel linux};
\end{itemize}

Para utilizar a UML é preciso um \textit{kernel} Linux compilado para a
arquitetura \textit{um} e um sistema de arquivos, que nada mais é do que um
simples arquivo contendo a imagem de um sistema, onde temos toda a estrutura de
diretórios e os demais componentes para uma execução normal de um Linux. A UML
realiza as operações de escrita e leitura de arquivos no sistema de arquivos,
analogamente ao que sistema hospedeiro realiza no disco rígido.

Para esta plataforma de testes, o \textit{kernel} linux-2.6.27 foi compilado com
vários recursos de rede. Um sistema de arquivos foi construído a partir da
distribuição \textit{GNU/Linux Debian Lenny}. A idéia foi construir um pequeno
sistema dedicado para laboratórios de redes. Ele inclui as implementações dos
protocolos de rede e um conjunto de utilitários para solucionar problemas de
rede.

Os principais componentes e recursos de rede disponíveis no \textit{kernel}
compilado e no sistema de arquivos são:
\begin{itemize}
 \item Implementações do MIPv6 e HMIPv6;
 \item Implementações dos protocolos de roteamento RIPv2, RIPng, OSPFv2, OSPFv3
e BGP4;\begin{large}       \end{large}
 \item Utilitários de rede: \textit{tcpdump}, \textit{ping}, \textit{ping6},
\textit{traceroute}, \textit{ip}( mostra e manipula rotas, dispositivos,
políticas de roteamento e túneis), \textit{iptables}, \textit{tc};
 \item Ferramentas IPSec;
 \item \textit{Kernel} suporte para \textit{Netfilter};
 \item \textit{Kernel} suporte para Qualidade de serviço (QoS);
 \item \textit{Kernel} suporte para IP Seguro (IPSec) pra IPv4 e IPv6;
 \item \textit{Kernel} suporte a mobilidade e otimização de roteamento em redes
IPv6;
\end{itemize}

Outros componentes e recursos podem facilmente ser adicionados a plataforma de
testes.

\subsection{Redes Virtuais Móveis com a Máquina UML}
\label{redes_virtuais_com_uml}
UML oferece dois tipos de redes para as máquinas virtuais: uma que permite
conectar a UML com o hospedeiro e uma outra denominada redes virtuais isoladas
onde somente fazem parte instâncias UML. No primeiro tipo de rede as tecnologias
de transporte utilizados pela UML são: \textit{TUN/TAP}, \textit{Ethertap},
\textit{SLIP} e \textit{Slirp}. No segundo tipo: \textit{switch} virtual e
\textit{Multicast}.

Nos cenários de rede, para testes dos protocolos de rede, foram utilizadas as
redes virtuais isoladas. O programa \textit{uml\_switch}, integrante do pacote
UML, permite a interligação
das máquinas virtuais. Ele é um utilitário que implementa um \textit{switch
Ethernet} ou um \textit{hub} em \textit{software}. As máquinas UML se conectam
ao \textit{switch} e se comunicam por meio de um arquivo de domínio \textit{UNIX
sockets} no hospedeiro.

Na figura \ref{f_plataforma_vnuml} observamos as duas formas de redes virtuais
UML. Note que a flexibilidade da máquina virtual permite à instância UML
participar das duas redes.

\begin{figure}[!htpb]
    \centering
    \includegraphics[scale=.6]{figs/vnuml}
    \caption{Redes Virtuais UML}
    \label{f_plataforma_vnuml}
\end{figure}

Em geral, uma plataforma de testes de mobilidade envolve o uso de redes sem fio,
contudo os protocolos estudados são em níveis de camada 3 sendo a mudança de
portas em um \textit{switch} suficiente para verificar boa parte do
comportamento dos protocolos.  Tornou-se necessário então fazer alterações no
programa do \textit{uml\_switch}, que é um software livre sobre a \ac{GPLv2},
escrito na linguagem de programação C. 

\subsubsection{O uml\_switch para Mobilidade}
\label{uml_switch_movel}
A principal alteração no código fonte do \textit{uml\_switch} foi a inclusão da
possibilidade de segmentação de redes, permitindo a criação de uma espécie de
\ac{VLAN}. Desta forma é possível realizar a mobilidade dos nós conectados
ao \textit{switch}. Após a mudança, cada nó conectado ao \textit{switch}
pertence a uma VLAN e é possível mover o nó para outra VLAN.

Outra implementação que foi realizada no \textit{uml\_switch} foi a adição de
uma \textit{thread} que responde um servidor \textit{telnet}, que basicamente
tem duas funções. A primeira é permitir o usuário efetuar a mobilidade dos
nós conectados no \textit{switch}. A outra função, é listar os nós conectados.
Esse recurso torna fácil a implementação de uma interface gráfica do
\textit{switch}, pois um outro programa, em outra linguagem de programação, pode
utilizar-se deste recurso para gerar a interface.

Os comandos que o servidor telnet do uml\_switch pode aceitar são:
\begin{itemize}
 \item \textit{list}: Lista as portas do switch e as \acp{VLAN} a elas 
associadas;
 \item \textit{move} porta VLAN: move uma porta do \textit{switch} para
uma VLAN;
 \item \textit{quit}: encerra a conexão.
\end{itemize}


\section{GUML4MIP - Interface Gráfica de controle de terminais UML para o IP
Móvel}

\subsection{A GUML4MIP do ponto de vista do usuário}
A máquina virtual UML tem se mostrado uma ótima ferramenta para a plataforma
de teste. Porém, a sua utilização na construção de redes virtuais não é muito
prática, porque para cada cenário é necessário a criação de \textit{scripts}
para iniciar as máquinas e configurar as redes. Isto torna a construção de
cenários demorada e não tão evidente, além do fato de que o usuário necessita de
bons conhecimentos do sistema operacional \textit{linux}, indo um pouco contra a
idéia proposta pela plataforma.

Pelo motivo apontado teve-se a idéia de construir uma interface gráfica,
amigável para o usuário, de forma a possibilitar: a construção rápida de
cenários com
redes, o controle da mobilidade dos nós e a centralização de todos os terminais
das máquinas virtuais em uma única janela. Esta última característica evitaria
que, em cenários muito complexos, um grande número de janelas
fossem abertas, diminuindo a produtividade durante sua utilização.

Após algumas pesquisas na \textit{internet} foi encontrado o projeto de código
aberto \ac{GUML} \cite{guml}, implementada com a
linguagem de programação \textit{Python} e que já contempla muitos dos recursos
pretendidos. Decidiu-se fazer alterações no código fonte deste projeto de forma
a implementar os novos recursos almejados.

Como citado, apesar de possuir vários recursos, o GUML não fornece suporte para
configu-ração de cenários de rede integrado na ferramenta. Não é seu intuito
ser uma interface para construção de cenários de redes móveis e sim para
controle de terminais UML. Por esse motivo optou-se fazer uma derivação do
projeto e criar um outro um chamado \ac{GUML4MIP}, baseado-se no seu código
fonte.

Os principais recursos incorporados ao GUML4MIP, que possibilitam e melhoram 
o suporte as redes virtuais, são:

\begin{itemize}
 \item Adição de parâmetros no arquivo de configuração, passando a ser
possível especificar:
\begin{itemize}
 \item A função da máquina UML: um roteador ou um nó hospedeiro;
 \item Endereço IP das interfaces das máquinas UML;
 \item A VLAN que a interface da máquina UML será atrelada;
 \item Serviços adicionais que poderão ser iniciados no \textit{boot} da máquina
UML. Por exemplo, o \textit{daemon} do MIPL ou do RADVD;
\end{itemize}
 \item Geração automática de \textit{scripts} de configuração de rede;
 \item Roteamento dinâmico utilizando o \textit{Zebra};
 \item Possibilidade de carregar novos cenários de rede em tempo de execução da
interface;
 \item Interface gráfica do \textit{uml\_switch} (ver figura
\ref{f_plataforma_gswitch}). Com este recurso o usuário pode visualizar o estado
do \textit{uml\_switch} durante a 
execução do cenários;
 \item Controle da mobilidade das máquinas UML por meio da interface do
\textit{uml\_switch}.
\end{itemize}

Foi também adicionado ao pacote do GUML4MIP um aplicativo, chamado
\textit{create\_fs}, que constrói automaticamente o sistema de arquivos
especificado neste capítulo para a plataforma de testes.

Para utilizar o GUML4MIP o usuário deve configurar um arquivo para cada máquina
UML. No arquivo de configuração é possível declarar: 
\begin{itemize}
 \item O sistema de arquivo que a máquina virtual irá utilizar;
 \item Quantidade de memória para a máquina virtual;
 \item Interfaces de rede;
 \item Discos;
\end{itemize}

Um exemplo de arquivo de configuração do GUML4MIP pode ser observado no anexo
\ref{c_anexo_guml4mip}.

Na figura \ref{f_plataforma_guml} podemos observar o visual da interface,
rodando um cenário de rede, e os recursos disponíveis ao usuário. Abaixo 
uma explicação detalhada das funções que o usuário pode realizar na interface:
\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.55]{figs/guml4mip}
	\caption{Interface Gráfica de controle de terminais UML para o IP Móvel}
	\label{f_plataforma_guml}
\end{figure}

\begin{description}
  \item[\textit{Boot !}] Clicando neste botão, o usuário inicia a máquina UML
selecionada no quadro que lista as máquinas do cenário;
  \item[\textit{Boot All}] Este botão permite que o usuário inicie todas as
máquinas UML configuradas para o cenário, a direita por meio das abas, o usuário
pode acessar o terminal das máquinas virtuais;
  \item[\textit{Uml Switch}] Clicando neste botão, uma nova janela será aberta.
Na janela do \textit{uml\_switch}, figura \ref{f_plataforma_gswitch}, o usuário 
pode observar todas as máquinas virtuais conectados a ele, e a qual
VLAN cada interface de rede esta associada. Caso o usuário queira
efetuar alguma mobilidade basta clicar no número da VLAN a qual queira
se associar;
  \item[\textit{Load Scenario}] Por meio deste botão, o usuário busca o
diretório onde estão os arquivos de configuração de um novo cenário de rede. O
ultimo cenário executado é salvo e na próxima execução do programa já é
carregado automaticamente.
  \item[\textit{Quit}] Encerra o programa.
\end{description}

%% figuras do guml modificado e do uml switch
\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/uml_switch}
	\caption{Interface Gráfica para o \textit{uml switch}}
	\label{f_plataforma_gswitch}
\end{figure}

\subsection{Funcionamento do GUML4MIP}

O programa GUML4MIP possui um funcionamento bem simples, por esse motivo se
torna uma aplicação versátil e facilmente alterável. Na figura
\ref{f_plataforma_gfunc}
é mostrado um diagrama  dos principais blocos do GUML4MIP. A relação e o
funcionamento dos blocos são descritos a seguir.:

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.5]{figs/guml4mip_func}
	\caption{Funcionamento simplificado do GUML4MIP}
	\label{f_plataforma_gfunc}
\end{figure}

\begin{description}
 \item[setup.py:] Programa que desempenha a função de instalador e
desinstalador do GUML4MIP. Também é dele a função de criar o sistema de arquivos
que será utilizado pelo \textit{kernel} UML, instalar no hospedeiro o pacote do
\textit{uml\_switch:} modificado com suporte a mobilidade e os pacotes dos
protocolos de rede no sistema de arquivos.
\item[guml4mip.py:] Constitui-se no bloco principal de todo o diagrama.
Ele comanda todas as funções do programa e também a interface com o usuário. Seu
funcionamento é dividido nas etapas a seguir:
\begin{enumerate}
 \item Ao iniciar, é realizada a leitura dos arquivos de configuração das
máquinas UML no diretório do cenário a ser executado. Na primeira execução do
programa, o cenário carregado é um exemplo que acompanha o pacote do GUML4MIP.
Nas outras execuções, o último cenário executado é o padrão;
 \item A partir dos arquivos de configuração são criadas as linhas de comando
que executarão as máquinas UML e o arquivo \textbf{guml4mip.conf}. Este último
é o \textit{script} que configura as interfaces de rede das máquinas UML e que
inicia os \textit{daemons} especificados pelo usuário;
 \item O processo do \textit{uml\_switch} é iniciado, processo este no qual as
máquinas UML irão se conectar. Em paralelo uma \textit{thread} é criada e se
conecta ao servidor;
\textit{telnet} do \textit{uml\_switch}. Por meio desta conexão, o GUML4MIP
monitora as conexões no \textit{uml\_switch}, apresentando em uma
interface gráfica o estado do \textit{switch}. A partir desta interface p
ode-se provocar a mobilidade das máquinas UML;
 \item Os recursos do programa são disponibilizadoas ao usuário em uma janela 
construída em \ac{PyGTK};
 \item Ao utilizar função que permite carregar um novo cenário, através do
botão \textit{Load Scenario}, o programa encerra os processos das máquinas do 
cenário anterior e finaliza a conexão com servidor telnet do
\textit{uml\_switch}. O mesmo acontece quando é acionado o botão \textit{Quit},
porém, neste caso reiniciam-se todas as etapas.
\end{enumerate}
\item[linux.uml:] São os processos (\textit{kernel}) das máquinas UML iniciados
pelo programa, configuradas conforme seu arquivo de configuração e conectadas em
sua VLAN. Seus terminais tornam-se disponíveis na interface;
\item[uml\_switch:] Processo do \textit{uml\_switch} sempre iniciado no começo
de um novo cenário de rede. Responsável por segmentar a rede em \acp{VLAN},
entregar os pacotes as portas corretas e responder as requisições da
sua interface gráfica, via \textit{telnet}.
\end{description}
