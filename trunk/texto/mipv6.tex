% ----------------------------------------------------------------------- %
% Arquivo: mipv6.tex
% ----------------------------------------------------------------------- %
\chapter{Visão geral do protocolo MIPv6}
\label{c_mipv6}

\section{Introdução}
\label{s_mipv6_intro}
Na internet, cada pacote associado ao um fluxo de pacotes entre pontos comunicantes, é encaminhado em função do endereço de IP destino. Cabe ao protocolo de camada de rede chamado \textit{Internet Protocol} (IP), escolher qual caminho o pacote deve seguir para chegar ao seu destinatário, em redes muito complexas como a \textit{Internet} alguns protocolos de roteamento auxiliam na descoberta da localização dos destinos dinamicamente. Alguns exemplos de protocolos de roteamento são o \textit{Open Shortest Path First} (OSPF), \textit{Routing Information Protocol} (RIP) e \textit{Border Gateway Protocol} (BGP).

Os endereços IP acabam definindo a localização geográfica de um ponto de acesso, os protocolos atuais da \textit{Internet} assumem que o nó não muda seu endereço IP durante uma comunicação, ou seja não troca o seu ponto de acesso.

Caso um nó mude seu ponto de acesso na \textit{Internet}, normalmente ele deve reconfigurar um novo endereço IP e um roteador padrão, se uma comunicação estiver estabelecida quando o nó efetuar a mobilidade os protocolos de roteamento não serão mais capazes de entregar os pacotes corretamente. Para continuar sua comunicação sua nova rota deve ser propagada para toda estrutura de roteamento da rede, obviamente esta alternativa é inaceitável, pois seria inviável fazer isso em uma rede como a \textit{Internet}.

Com a intenção de permitir que nós possam se movimentar para diferentes sub-redes e continuar suas comunicações, foi proposto o protocolo IP Móvel que garante que os pacotes sejam roteados para os nós móveis. Existem duas variações para o IP Móvel uma para o IPv4 e outra para o IPv6.

O foco deste trabalho será na versão para o IPv6, pois o IPv6 possui algumas vantagens sobre o IPv4 como maior número de endereços, suporte nativo para segurança, possibilidade de auto-configuração e suporte ao IP Móvel.

O protocolo IPv6 móvel (MIPv6) tem por objetivo permitir que nós IPv6 se desloquem entre sub-redes, com diferentes tecnologias de acesso como \textit{Ethernet} e \textit{Wireless LAN} e continuem suas comunicações. Sem suporte ao MIPv6 todos os pacotes destinados ao nó móvel quando ele estiver fora de sua rede origem serão perdidos.

O protocolo possibilita ao nó móvel comunicar-se com outros nós, móveis ou estáticos, após mudar seu ponto de conexão e ser alcançado pelo mesmo endereço IP, tornando a mobilidade transparente para as camadas superiores a de rede.

\section{Terminologia do MIPv6}
\label{s_mipv6_term}
Alguns termos definidos pelo MIPv6:

\begin{description}
\item[Nó móvel:] é o terminal de rede que pode trocar seu ponto de acesso a internet sem deixar de ser alcançável via seu endereço domiciliar.
\item[Endereço domiciliar:] é o endereço estático associado ao nó móvel na rede domiciliar.
\item[\textit{Link} domiciliar:] \textit{link} onde o prefixo de subrede do nó movel é definido.
\item[Link externo:] algum \textit{link} que não seja \textit{link} domiciliar do nó móvel.
\item[\textit{Care-of-address}:] endereço IP dado ao nó móvel quando estiver em um \textit{link} externo, o prefixo da rede deste endereço é o da rede externa.
\item[Nó correspondente:] é o nó com quem o nó móvel esta se correspondendo, pode ser móvel ou fixo.
\item[Agente domiciliar:] é um roteador no \textit{link} domiciliar com quem o nó móvel registra seu \textit{care-of-address} sempre que esta em um \textit{link} externo.
\item[Movimento:] é uma troca de ponto de acesso na Internet.
\item[\textit{Binding}:] é associação do endereço domiciliar do nó móvel com seu \textit{care-of-address}.
 \end{description}

\section{Funcionamento}
\label{s_mipv6_func}
No contexto do MIPv6 um nó móvel está sempre acessível por um mesmo endereço IP, independente de seu ponto de conexão com a \textit{Internet}. Este endereço é chamado de endereço domiciliar e é o endereço IPv6 fixo global do nó móvel na sua rede de origem. Todos os nós correspondentes se utilizam deste endereço para se comunicar com o nó móvel.

Enquanto um nó móvel estiver fora de sua rede de origem ele terá no mínimo dois endereços atribuídos a sua interface de rede:
\begin{enumerate}
\item O endereço domiciliar sempre permanente;
\item Um endereço chamado de \textit{care-of-address}, que se refere a rede visitada. A cada nova rede será configurado um \textit{care-of-address}.
\end{enumerate}

O \textit{Care-of-address} pode ser obtido pelas formas convencionais do IPv6, ou seja, por \textit{stateless autoconfiguration}, no qual o endereço é gerado por meio de informações divulgadas pelos roteadores das sub-redes, ou por \textit{stateful autoconfiguration}, onde o endereço e outros parâmetros de configuração são providos diretamente de um servidor, por exemplo, os mecanismos DHCPv6 e PPPv6.

Na rede visitada, após detectar o movimento e configurar seu \textit{care-of-address}, o nó móvel envia uma mensagem icmp de \textit{Binding Update} para seu agente domiciliar, e este faz a associação de seu endereço domiciliar com o seu \textit{care-of-address}. O agente domiciliar registra a mensagem em seu \textit{cache} e em resposta envia um \textit{Binding Acknowledgement}. Então passa a atuar como um \textit{proxy} interceptando todos os pacotes com destino ao nó móvel e enviando-os via túnel. O nó móvel pode também informar ao nó correspondente sua localização. Neste caso, assim que o nó correspondente atualizar seu \textit{cache}, ele encaminhará os pacotes diretamente ao nó móvel.

Duas formas de comunicação portanto podem ser realizadas entre o nó móvel e o correspondente: no primeiro modo com tunelamento bidirecional, todos os pacotes são encaminhados via agente domiciliar. Neste caso os pacotes com origem no nó correspondente são roteados para o agente domiciliar e este envia ao nó móvel via túnel. Os pacotes enviados pelo nó móvel, com destino ao nó correspondente são enviandos via túnel ao agente domiciliar (túnel reverso) e estes são roteados normalmente da rede domiciliar para o nó correspondente. O agente domiciliar utiliza \textit{proxy Neighbor Discovery} para interceptar os pacotes com destino ao nó móvel. Neste modo o nó correspondente não precisa ter suporte ao MIPv6.

O segundo modo, mais eficiente, chamado de otimização de roteamento. O nó móvel também faz uma associação do seu \textit{care-of-address} com o nó correspondente e este pode começar a endereçar os pacotes diretamente ao \textit{care-of-address}, eliminando assim o congestionamento e possíveis falhas no \textit{link} entre o nó móvel e o agente domiciliar.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.5]{figs/mipv6}
 	\label{f_mipv6}
	\caption{Modos de operação simplificados do MIPv6}
\end{figure}

A figura \ref{f_mipv6} permite observar de forma simplificada os dois modos de operação do protocolo MIPv6.

Enquanto estiver em uma rede visitada o nó móvel terá, portanto, mais de um endereço configurado em sua interface, o endereço domiciliar e um ou mais \textit{care-of-address}. Ele pode usar qualquer um desses endereços para se comunicar. Com o intuito de manter a trasparência para as camadas superiores à de rede o nó móvel irá utilizar geralmente seu endereço domiciliar.

Ao enviar estes pacotes, eles deverão ser modificados inserindo o \textit{care-of-address} no campo endereço de origem e movendo o endereço domiciliar para o campo \textit{home address}. No receptor do pacote estas alterações devem ser revertidas para manter a transparência para as camadas superiores.

Conforme a RFC 3775 \cite{rfc3775}, o \textit{Handover} pode ser definido como o processo em que o nó móvel muda seu ponto de acesso, percebe a mudança de sub-rede e configura um novo \textit{care-of-address}.

Uma das mais complicadas tarefas em mobilidade é o gerenciamento do \textit{handover} pelo nó móvel. O gerenciamento do \textit{handover} pode se dar em diferentes camadas da arquitetura rede. O \textit{handover} de camada enlace refere-se a descoberta e conexão há uma nova rede. O \textit{handover} na camada rede é, no caso da arquitetura IPv6, envolve portanto:
\begin{enumerate}
 \item Descoberta de um novo roteador.
 \item Auto configuração do \textit{care-of-address}.
 \item Teste de duplicidade do \textit{care-of-address} (DAD).
 \item Registro com o agente domiciliar e o nó correspondente.
\end{enumerate}

O início de um \textit{handover} de camada 3 se dá a partir do protocolo \textit{Neighbor Discovery} presente no IPv6, utilizando-se dos mecanismos \textit{Router Discovery} e \textit{Neighbor Unreachability Detection} para realizar a detecção.

O \textit{Neighbor Unreachability Detection} \cite{rfc2641} é base do protocolo \textit{Neighbor Discovery}. Com ele é possível detectar roteadores e vizinhos inalcançáveis, falhas de conectividade. Caso detecte uma falha de conectividade o tráfego não é enviado para os vizinhos inacessíveis, resolvendo questões de \textit{cache} ARP desatualizado.

O \textit{Router Discovery} \cite{rfc2641} é o mecanismo que permite que nós IPv6 descubram roteadores existentes no seu enlace, através das mensagens \textit{Router Advertisement} e \textit{Router Solicitation}. Um roteador IPv6 periodicamente envia mensagens de \textit{Router Advertisement} para todo o enlace, desta forma os nós podem configurar seu endereço de rede (\textit{stateless autoconfiguration}) e roteadores padrão. O nó também pode enviar uma mensagem de \textit{Router Solicitation} recebendo como resposta um \textit{Router Advertisement}.

Desta forma o nó móvel pode perceber o movimento quando receber um \textit{Router Advertisement} de um novo roteador ou quando perceber que seu roteador não esta mais alcançável, então deve requisitar um novo. Por meio das mensagens trocadas na descoberta do novo roteador o nó móvel é capaz de gerar seu \textit{care-of-address}, então o teste de duplicidade deve ser feito para verificar se não há um endereço igual no \textit{link}, com sucesso o registro com o agente domiciliar e o nó correspondente deve ser efetuado finalizando o processo de \textit{handover}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.5]{figs/fluxo_mipv6}
 	\label{f_messages}
	\caption{Diagrama de sequencia do MIPv6}
\end{figure}

Na figura \ref{f_messages} é possível observar um diagrama de sequêcia do funcionamento do MIPv6 abordado nesta seção. As trocas de mensagens mais importantes foram enumeradas e a seguir são discutidas:
\begin{enumerate}
 \item Até então o nó móvel vinha trocando mensagens com o nó correspondente em sua rede domiciliar. Seu ponto de acesso de muda, com a mensagem de \textit{Router Advertisement} do roteador na rede visitada é capaz de detectar o movimento.
 \item Com as infomações recebidas na mensagem do roteador, o nó móvel é capaz de gerar seu \textit{care-of-address}. Então efetua o teste de duplicidade de endereço com as mensagens de \textit{Neighbor Solicitation}.
 \item Com o sucesso do DAD o nó móvel faz o registro com o seu agente domiciliar, enviando o \textit{Binding Update} e recebendo como resposta um \textit{Binding Acknowledgement}.
 \item A partir dai as mensagens entre o nó móvel e o nó correspondente são trocadas utilizando tunelamento bidirecional via agente domiciliar.
 \item Para otimizar o roteamento o nó móvel faz o registro do seu \textit{care-of-address} com o nó correspondente, assim a comunicação entre os eles se da de forma normal, sem a necessidade de encaminhar os pacotes ao agente domiciliar.
\end{enumerate}


\section{Mensagens do MIPv6}
\label{s_mipv6_mes}
O MIPv6 define um novo cabeçalho de extensão ao protocolo IPv6 o \textit{Mobility Header}, o cabeçalho de mobilidade é utilizado pelos nós móveis e correspondentes, e o agente domiciliar para enviar as mensagens utilizadas no MIPv6. O cabeçalho de mobilidade é identificado pelo valor 135 no \textit{Next Header}.

As mensagens enviadas utilizando o cabeçalho de mobilidade são as seguintes:
\begin{enumerate}
 \item \textbf{\textit{Binding Refresh Request} (BRR)}: mensagem enviada pelos nós correspondentes requisitando atualização do registro de mobilidade.
 \item \textbf{\textit{Home Test Init} (HoTI)}: mensagen enviada pelo nó móvel, inicia o \textit{Return Routability Procedure} e requisita o \textit{home keygen token} ao nó correspondente.
 \item \textbf{\textit{Care-of Test Init} (CoTI)}: mensagem envianda pelo nó móvel, inicia o \textit{Return Routability Procedure} e requisita o \textit{care-of keygen token} ao nó correspondente.
 \item \textbf{\textit{Home Test} (HOT)}: mensagem em resposta a HoTI enviada pelo nó correspondente ao nó móvel.
 \item \textbf{\textit{Care-of Test} (COT)}: mensagem em resposta a CotI enviada pelo nó correspondente ao nó móvel.
 \item \textbf{Binding Update}: mensagem utilizada para notificar ao agente domiciliar e aos nós corresondentes o novo \textit{care-of-address}.
 \item \textbf{Binding Acknowledgement}: mensagem utilizada para confirmar o \textit{Binding Update}.
 \item \textbf{Binding Error}: mensagem enviada pelos nós correspondentes para informar erro na mobilidade relatada pelo nó móvel.
\end{enumerate}

\subsection{\textit{Binding Update}}
\label{sub_mipv6_bu}
Mensagem essencial ao MIPv6, pois informa ao agente domiciliar e ao nós correspondentes uma mobilidade efetuada pelo nó móvel. O seu formato pode ser observado na figura \ref{f_bu_header}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=0.7]{figs/bu_header}
 	\label{f_bu_header}
	\caption{Formato da Mensagem de \textit{Binding Update}}
\end{figure}

\begin{description}
 \item[\textit{Sequence \#}:] um inteiro sem sinal de 16 bits, usado para informar a sequência do \textit{Binding Update}, é reenviando no \textit{Binding Acknowledgement} de resposta.
 \item[\textit{Acknowledge} (A):] este bit quando ligado requisita um \textit{Binding Acknowledgement} como resposta.
 \item[\textit{Home Registration} (H):] este bit quando ligado requisita que o recepetor atue como um agente domiciliar.
 \item[\textit{Link-Local Address Compatibility} (L):] este bit é ligado quando o endereço domiciliar reportado pelo nó móvel é o mesmo do que esta configurado na interface.
 \item[\textit{Key Management Mobility Capability} (K):] o bit deve estar desligado quando há uma configuração manual do IPsec.
 \item[\textit{Lifetime}:] um inteiro sem sinal de 16 bits, indica o tempo restante antes da associação. Se tiver o valor zero o endereço deve ser retirado do \textit{cache}.
 \item[\textit{Mobility Options}:] campo de tamanho variável que pode conter um \textit{care-of-address} alternativo e opções utilizadas no \textit{Return Routability Procedure}.
\end{description}

Uma mensagem de \textit{Binding Update}, ao agente domiciliar deve seguir os seguintes requisitos:
\begin{itemize}
 \item bit H (\textit{home registration}) deve estar ligado;
 \item bit A (\textit{acknowledge}) deve estar ligado;
 \item o pacote deve ter a opção de agente domiciliar preenchida;
 \item  endereço de origem do pacote deve ser o \textit{care-of-address} a ser registrado, a menos
que a sub-opção de \textit{care-of-address} alternativo esteja sendo utilizada;
 \item o tempo de vida do \textit{binding} deve ser menor ou igual ao do \textit{care-of-address}. 
\end{itemize}

Quando o nó móvel retornar a sua rede de origem deve enviar um \textit{Binding Update} para o seu agente domiciliar com o valor de \textit{lifetime} igual a zero, para que este pare de interceptar e tunelar os pacotes destinados a ele.

\subsection{\textit{Binding Acknowledgement}}
\label{sub_mipv6_ba}
A mensagem \textit{Binding Acknowledgement} é utilizada para inforamar o recebimento de um \textit{Binding Update}. O seu formato pode ser observado na figura \ref{f_ba_header}.
\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=0.7]{figs/ba_header}
 	\label{f_ba_header}
	\caption{Formato da mensagem de \textit{Binding Acknowledgement}}
\end{figure}

\begin{description}
 \item[\textit{Status}:]inteiro de 8 bits, indica a resposta do \textit{Binding Update} valores menores de 128 indicam que o \textit{Binding Update} foi aceito pelo nó que o recebeu, maiores que 128 indicam que o \textit{Binding Update} foi rejeitado.
 \item[\textit{Key Management Mobility Capability} (K):] o bit deve estar desligado quando há uma configuração manual do IPsec.
 \item[\textit{Sequence \#}:] é o número de sequência do \textit{Binding Acknowledgement} é copiado do \textit{Binding Update}.
 \item[\textit{Lifetime}:] tempo em que o \textit{care-of-address} vai permanecer no \textit{cache}.
 \item[\textit{Mobility Options}:] campo de tamanho variável que comtêm opções utilizadas no \textit{Return Routability Procedure}.
\end{description}

\section{Considerações sobre Segurança}
\label{s_mipv6_secure}
O uso de \textit{Binding Updates} não autenticados é tido como um sério problema de segurança, pois, um nó mal intencionado pode forjar um registro com o nó correspondente e passar a receber os pacotes destinados ao nó móvel. Com a intenção de solucionar este problema de segurança, o protocolo MIPv6 implementa alguns mecanismos.

Para dar mais proteção no processo de \textit{Binding Update} com o agente domiciliar pode se utilizar o protocolo IPsec nativo no IPv6. A troca de mensagens é feita utilizando um dos cabeçalhos de segurança:
\begin{itemize}
 \item \textit{Authentication Header} (AH), representa um cabeçalho de extensão do protocolo IPv6 e foi criado para indentificar a identidade dos pontos comunicantes.
 \item \textit{Encapsulating Security Payload Header} (ESP), representa um cabeçalho de extensão do protocolo IPv6 que fornece integridade e confidencialidade aos datagramas IP por meio da cifra dos dados contidos no datagrama.
\end{itemize}

Para o uso de um dos cabeçalhos de segurança é necessário um relacionamento prévio de segurança entre o nó móvel e o agente domiciliar, ou seja, uma chave secreta deve ser configurada nos dois nós.

No processo do registro do nó móvel com o nó correspondente torna-se impossível utilizar o IPsec para prover segurança no processo, pois o nó correspondente pode ser estar localizado em qualquer lugar na \textit{Internet} e uma chave secreta não pode ser pré-configurada. Para tornar o processo seguro faz-se necessário o uso de algum mecanismo global de autenticação automática. A solução proposta para esse problema é conhecida como \textit{Return Routability Procedure}. 

\subsection{\textit{Return Routability Procedure}}
\label{sub_mipv6_rrp}
Na tentativa de tornar mais seguro o registro do nó móvel com o nó correspondente o MIPv6 introduz uma solução bastante inteligente: o \textit{Return Routability Procedure}. A idéia do processo é que o nó correspondente obtenha garantias de que o nó móvel seja alcançável pelo seu endereço domiciliar e o \textit{care-of-address}. Somente assim o nó correspondente estará apto para receber \textit{Binding Updates}.

O teste consiste em enviar, a partir do nó móvel, duas mensagens ao nó correspondente uma via agente domiciliar (\textit{Home Test Init}) e outra diretamente ao nó correspondente (\textit{Care-of Test Init}). Em resposta o nó correspondente envia duas mensagens (\textit{Home Test} e \textit{Care-of Test}). A partir dos dados destas mensagens o nó móvel é capaz de gerar uma chave de segurança denominada \textit{binding management key} (Kbm).

Na figura \ref{f_messages} pode-se observar o fluxo das mensagens utilizados no \textit{Return Routability Procedure}.
\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.5]{figs/rrp}
 	\label{f_rrp}
	\caption{Fluxo das mensagens no Return Routability Procedure}
\end{figure}

Para autorizar o \textit{Binding Update} o nó móvel gerou a Kbm que permite uma verificação por parte do nó correspondente. Ao receber o \textit{Binding Update} o nó correspondente é capaz de recalcular a Kbm e permitir a associação do \textit{care-of-address} com o endereço domiciliar.

É importante salientar que o \textit{Return Routability Procedure} não é totalmente seguro, pois um atacante pode capturar as mensagens enviadas pelo nó correspondente e forjar mensagens de \textit{Binding Updates}. Obviamente o mesmo atacante conseguirá fazer o mesmo ataque em uma rede IPv6 sem mobilidade. Podemos concluir que o \textit{Return Routability Procedure} não introduz riscos adicionais ao protocolo IPv6 básico. 
