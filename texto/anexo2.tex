% ----------------------------------------------------------------------- %
% Arquivo: anexo2.tex
% ----------------------------------------------------------------------- %

\chapter{Cenários}
\label{c_anexo2}

\begin{verbatim}
#!/bin/sh
#
# cenario.sh:	script que gera as máquinas e switches virtuais para os
#               dois cenários definidos no trabalho.
# Uso: 		./cenario.sh <cenario> <modo>
# cenario:	numero do cenário, 1 ou 2;
# modo:		modo de operação, 1 para tunelamento bidirecional,
#		2 para otimização de rotas.
# 
WD=~/vm
FSYS=DebianFS
LINUX=$WD/linux
CENARIO=$1
$MODO=$2
echo "Iniciando Cenario $CENARIO"
echo "Limpando cows"
rm $WD/cow-*
echo "Limpando pipes"
rm /tmp/net*
echo $MODO > $WD/conf
echo "Lancamento dos switches"
xterm -geometry 80x5 -T NET100 -e "uml_switch_mob -mob -unix /tmp/net100.ctl" &
if [ $CENARIO -eq 1 ]
then
  xterm -geometry 80x5 -T NET200 -e "uml_switch  -unix /tmp/net200.ctl"  &
else
  xterm -geometry 80x5 -T NET200 -e "uml_switch_mob -mob -unix /tmp/net200.ctl" &
fi
  xterm -geometry 80x5 -T NETGEN -e "uml_switch  -unix /tmp/netgen.ctl" & 
sleep 2
echo "Lancamento das maquinas virtuais UML"
xterm -T Mobile -e "$LINUX umid=MN  ubda=$WD/cow-MN,$WD/$FSYS mem=128M \
eth0=daemon,,,/tmp/net100.ctl" &
sleep 1
xterm -T AR1 -e "$LINUX umid=AR1 ubda=$WD/cow-AR1,$WD/$FSYS mem=128M \
eth0=daemon,,,/tmp/net100.ctl eth1=daemon,,,/tmp/netgen.ctl" &
sleep 1
if [ $CENARIO -eq 1 ]
then
  xterm  -T Correspondent -e "$LINUX umid=CN ubda=$WD/cow-CN,$WD/$FSYS \
  mem=128M eth0=daemon,,,/tmp/net200.ctl" &
else
  xterm  -T 'Mobile 2' -e "$LINUX umid=MN2 ubda=$WD/cow-MN2,$WD/$FSYS \
  mem=128M eth0=daemon,,,/tmp/net200.ctl" &
fi
sleep 1
xterm -T AR2 -e "$LINUX umid=AR2 ubda=$WD/cow-AR2,$WD/$FSYS mem=128M \
eth0=daemon,,,/tmp/net200.ctl eth1=daemon,,,/tmp/netgen.ctl" &
sleep 1
xterm -T AR3 -e "$LINUX umid=AR3 ubda=$WD/cow-AR3,$WD/$FSYS mem=128M \
eth0=daemon,,,/tmp/net100.ctl \ eth1=daemon,,,/tmp/netgen.ctl" &
sleep 1
if [ $CENARIO -eq 2 ]
then
  xterm -T AR4 -e "$LINUX umid=AR4 ubda=$WD/cow-AR4,$WD/$FSYS mem=128M \
  eth0=daemon,,,/tmp/net200.ctl eth1=daemon,,,/tmp/netgen.ctl" &
fi
PID=`ps x | grep mob | tail -2 | head -1 | cut -c 1-5`
echo "Pressione <enter> para a mobilidade"
read a
echo $PID
kill -USR1 $PID
echo "Pressione <enter> para retorno a rede"
read a
kill -USR1 $PID
echo "Pressione <enter> para parar a simulação"
read a
kill $(pidof linux)
kill $(pidof xterm)
echo "Fim da simulacao"
\end{verbatim}

\begin{verbatim}
#!/bin/bash
#
# cenario.conf:	script que configura as máquinas virtuais de acordo com sua
#               função na topologia do cenário.
# Nota: Deve ser copiado para o arquivo /etc/rc.local do sistema de arquivos.
#
mount none /host -t hostfs -o /home/user/vm
OPTION=`cat /host/conf`
NODO=$(basename $(cat /proc/cmdline | cut -f 1 -d " " | cut -f 2 -d "="\
     | cut -f 1 -d ","))
if [ "$NODO" = "cow-MN1" ]
then
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip -6 addr add 2000:a::1/64 dev eth0
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=0
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=1
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=1
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=1
   sleep 6 # Para garantir que home agent inicie antes
   if [ $OPTION -eq 1 ]
   then
      echo "Iniciando MIPv6 MN"
      /usr/local/sbin/mip6d -c /host/conf/mip6d.conf.MN &
   else
      echo "Iniciando MIPv6 MN com Route Optimization"
      /usr/local/sbin/mip6d -c /host/conf/mip6d.conf.MN &
   fi
elif [ "$NODO" = "cow-MN2" ]
then
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip -6 addr add 2000:c::1/64 dev eth0
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=0
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=1
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=1
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=1
   sleep 6 # Para garantir que home agent inicie antes
   if [ $OPTION -eq 0 ]
   then
      echo "Iniciando MIPv6 MN"
      /usr/local/sbin/mip6d -c /host/conf/mip6d.conf.MN2 &
   elif [ $OPTION -eq 1 ]
   then
      echo "Iniciando MIPv6 MN com Route Optimization"
      /usr/local/sbin/mip6d -c /host/conf/mip6d.conf.MN &
   fi	  
elif [ "$NODO" = "cow-AR1" ]
then
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip link set dev eth1 down
   ip link set dev eth1 up
   ip -6 addr add 2000:a::2/64 dev eth0
   ip -6 addr add 2000:b::1/64 dev eth1
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=1
   /sbin/sysctl -w net.ipv6.conf.all.proxy_ndp=1
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=0
   ip -6 route add 2000:c::/64 via 2000:b::2
   ip -6 route add 2000:d::/64 via 2000:b::3
   ip -6 route add 2000:e::/64 via 2000:b::4
   /usr/local/sbin/mip6d -c /host/conf/mip6d.conf.HA &
   sleep 1
   /usr/local/sbin/radvd -C /host/conf/radvd.conf.AR1 &
elif [ "$NODO" = "cow-AR2" ]
then	
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip link set dev eth1 down
   ip link set dev eth1 up
   ip -6 addr add 2000:c::2/64 dev eth0
   ip -6 addr add 2000:b::2/64 dev eth1
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=1
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=0
   ip -6 route add 2000:a::/64 via 2000:b::1
   ip -6 route add 2000:d::/64 via 2000:b::3
   ip -6 route add 2000:e::/64 via 2000:b::4
   /usr/local/sbin/mip6d -c /host/conf/mip6d.conf.HA &
   sleep 1
   /usr/local/sbin/radvd -C /host/conf/radvd.conf.AR2 &
elif [ "$NODO" = "cow-AR3" ]
then
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip link set dev eth1 down
   ip link set dev eth1 up
   ip -6 addr add 2000:b::3/64 dev eth1
   ip -6 addr add 2000:d::2/64 dev eth0
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=1
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=0
   ip -6 route add 2000:a::/64 via 2000:b::1
   ip -6 route add 2000:c::/64 via 2000:b::2
   ip -6 route add 2000:e::/64 via 2000:b::4
   sleep 1
   /usr/local/sbin/radvd -C /host/conf/radvd.conf.AR3
elif [ "$NODO" = "cow-AR4" ]
then
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip link set dev eth1 down
   ip link set dev eth1 up
   ip -6 addr add 2000:b::4/64 dev eth1
   ip -6 addr add 2000:e::2/64 dev eth0
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=1
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=0
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=0
   ip -6 route add 2000:a::/64 via 2000:b::1
   ip -6 route add 2000:c::/64 via 2000:b::2
   ip -6 route add 2000:d::/64 via 2000:b::3
   sleep 1
   /usr/local/sbin/radvd -C /host/conf/radvd.conf.AR4
elif [ "$NODO" = "cow-CN" ]
then
   ip -6 route flush all
   ip link set dev lo up
   ip link set dev eth0 down
   ip link set dev eth0 up
   ip -6 addr add 2000:c::1/64 dev eth0
   /sbin/sysctl -w net.ipv6.conf.all.forwarding=0
   /sbin/sysctl -w net.ipv6.conf.all.autoconf=1
   /sbin/sysctl -w net.ipv6.conf.all.accept_ra=1
   /sbin/sysctl -w net.ipv6.conf.all.accept_redirects=1
   ip -6 route add ::/0 via 2000:c::2
   if [ $OPTION -eq 2 ]
   then
      echo "Iniciando MIPv6 CN com Route Optimization"
      /usr/local/sbin/mip6d -c \
          /host/conf/mip6d.conf.CN
   fi
fi
\end{verbatim}

\begin{verbatim}

\end{verbatim}

