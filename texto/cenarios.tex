% ----------------------------------------------------------------------- %
% Arquivo: cenarios.tex
% ----------------------------------------------------------------------- %

\chapter{Cenários de Testes}

\section{A Preparação dos Cenários}

\subsection{Cenários Estudados}
Após os estudos bibliográficos sobre o protocolo MIPv6 e a preparação da
Plataforma de Testes para Mobilidade, iniciou-se a etapa de definição e
implementação de cenários com fins de analisar algumas funcionalidade dos
protocolos instalados, demonstrando desta forma as potencialidades do ambiente
desenvolvido.

Para analisar alguns mecanismos do protocolo e testar seus modos de operação,
dois cenários base foram definidos: cenário 1 com o MIPv6 e o cenário 2
com o HMIPv6. Para o primeiro cenário, duas variações foram realizadas. A
primeira, descrita na figura \ref{f_cenario1}, é testado o modo de operação por
tunelamento bi-direcional do MIPv6, sem a otimização de rota. A segunda variação
testa o modo de operação por otimização de roteamento. O cenário 2, descrito na
figura\ref{f_cenario2}, tem como objetivo verificar minimamente o
funcionamento do HMIPv6, em comunicações onde os nós correspondentes não
executam otimização de roteamento.

Os arquivos para a configuração dos cenários usados no GUML4MIP estão
disponíveis no diretório da documentação do projeto.

\section{Fundamentos para a Análise dos Cenários}
Na análise dos cenários estudados vamos localizar os seguintes aspectos:
\begin{itemize}
  \item a sequência e a natureza das mensagens trocadas entre os vários nós.
Neste aspecto, utilizaremos as saídas geradas pelos programas \textit{tcpdump};
  \item as tabelas de roteamento e as regras de roteamento analisadas em
situações chave, por exemplo, antes e depois da mobilidade;
  \item aspectos de desempenho e perdas de pacotes. Sabemos das limitações desta
análise em um ambiente virtual, mas esperamos obter dados relativos. Também
confrontaremos os dados obtidos com os resultados esperados segundo uma
abordagem analítica;
  \item a criação e a manipulação dos túneis entre o agente domiciliar e o nó
móvel antes e depois do movimento.
\end{itemize}

\subsection{Considerações sobre o Tempo de latência do \textit{Handover}}
O processo de \textit{handover} acontece quando o nó móvel muda seu ponto de
conexão de uma sub-rede para outra. O tempo de latência envolvido neste processo
\cite{xavier} pode ser dividida em quatro fases:

\begin{enumerate}
 \item \textbf{Detecção de Movimento (\textit{TD})}: Em um cenário real
representaria o tempo do \textit{handover} na camada de enlace até o primeiro
\textit{Router Advertisement}. Na plataforma de testes construída não
conseguimos simular a camada enlace e não se pode precisar com a exatidão a
latência envolvida no processo. Porém, para fins de estudo consideraremos para
nossos cenários o tempo entre a entrega do último pacote, de alguma conexão,
recebido na rede domiciliar e o primeiro \textit{Router Advertisement} na rede
visitada.

\begin{equation}
 TD = t1 - t0
\label{eq.td}
\end{equation}

\item \textbf{Configuração do \textit{Care-of-address} (\textit{TA})}: Tempo que
entre o primeiro \textit{Router Advertisement} e o envio do
\textit{Binding Update}.

\begin{equation}
 TA = t2 -t1
 \label{eq.ta}
\end{equation}

\item \textbf{Registro com agente domiciliar (\textit{TR})}: Intervalo de tempo
entre o envio do \textit{Binding Update} ao agente domiciliar e o recebimento do
\textit{Binding Acknowledgement}.

\begin{equation}
 TR = t3 - t2
 \label{eq.tr}
\end{equation}

\item \textbf{Otimização de Roteamento (\textit{TO})}: Intervalo de tempo entre
o envio das mensagens do \textit{Return Routability Procedure} e o recebimento
do \textit{Binding Acknowledgement} do nó correspondente.

\begin{equation}
 TO = t4 - t3
 \label{eq.to}
\end{equation}

\end{enumerate}

Obviamente podemos calcular o tempo de latência do handover com a seguinte
fórmula:

\begin{equation}
 TH = TD + TA + TR + TO
 \label{eq.th}
\end{equation}

\subsection{Metodologia para Realização dos Cenários}
Nos cenários propostos o nó móvel inicialmente estará em sua rede domiciliar e
depois irá movimentar-se e visitar outras redes. Durante o procedimento de
movimento testes serão realizados para a coleta de dados que irão ajudar na
análise do protocolo.

Em um teste o nó correspondente começa a enviar mensagens ICMPv6 por meio do
\textit{ping6} para o nó móvel.
\begin{verbatim}
cn# ping6 mn
\end{verbatim}

E o nó móvel é executa o \textit{tcpdump} em o modo \textit{verbose} (-vvv) para
realizar o monitoramento da troca de mensagens do funcionamento do MIPv6 durante
o processo de \textit{handover}.
\begin{verbatim}
mn# tcpdump -vvv
\end{verbatim}

Outro procedimento de teste que poderá ser realizado durante a execução dos
cenários é uma conexão utilizando os protocolos da camada transporte, por
exemplo, o TCP para comprovar a transparência do processo de mobiliade para as
camadas superiores a de rede. Também neste teste pode ser gerado um fluxo de
dados maior do que com as mensagens ICMPv6. O que permite observar melhor o
impacto do protocolo MIPv6 sobre as conexões.

Para realização do teste é iniciado, no nó móvel, um servidor TCP que responde
a 
requisição GET do protocolo HTTP, é também capaz de gerar tráfego. Para realizar
esta tarrefa é utilizado a ferramenta \textit{netcat6}.
\begin{verbatim}
mn# echo "200 OK" > header; cat header /dev/zero | nc6 -l -p 80
\end{verbatim}

\begin{description}
 \item[echo ``200 OK'' "> header:] cria um cabeçalho HTTP com a mensagem ``200 
OK'', para responder as requisições ao servidor;
 \item[nc6 -l -p 80:] inicia um soquete TCP que (-l) escuta a (-p 80) porta 80;
 \item[cat header /dev/zero:] concatena para a entrada padrão do servidor o
arquivo contendo a mensagem HTTP e o dispositivo caracter /dev/zero que é
responsável por gerar o tráfego.
 \end{description}

O nó correspondente irá se conectar ao servidor utilizando da ferramenta 
\textit{wget}. Também no nó correpodente executamos a ferramenta 
\textit{speedometer} que é capaz de medir a taxa média de dados de uma interface
de rede. A saída do \textit{speedometer} permite criar um gráfico para
visualizar o efeito do MIPv6 em uma conexão.

\begin{verbatim}
cn# wget -6 --limit-rate=1M http://mn -o /dev/null -O /dev/null &
cn# speedometer -p -i 0.1 -rx eth0
\end{verbatim}

Sobre os comandos executados no nó correspondente as seguintes considerações:
\begin{itemize}
 \item O gerador utilizando o /dev/zero gera uma taxa muito elevada de dados o
que ocasiona o travamento das máquinas virtuais. Para resolver este problema é
limitado (--limit-rate=1M) a taxa para um 1MBps;
 \item A sáida de \textit{log} e o arquivo e os dados gerados são direcionados
ao /dev/null;
 \item o \textit{speedtometer} vai monitorar a (-rx eth0) recepção da interface
eth0 a uma (-i 0.1) taxa de 0.1 segundos
\end{itemize}

\section{Cenário 1 - Uso do Protocolo MIPv6}
\label{s_cenario1}

\subsection{Descrição da Topologia}
O primeiro cenário de teste é formado por três redes interligadas entre si e
cinco nós. A sua topologia pode ser observada na figura \ref{f_cenario1}, onde o
numero nos balões cinza representam a vlan no \textit{uml-switch}. Os endereços
atribuídos as interfaces dos nós, durante a realização do cenário, bem como seus
endereços de hardware estão disponíveis na tabela \ref{t_addr1}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.4]{figs/cenario1}
	\caption{Topologia do Cenário 1}
	\label{f_cenario1}
\end{figure}


Na rede com prefixo 2000:a::/64 está o nó correspondente com quem o nó móvel
está se comunicando. Na rede com o prefixo 2000:c::/64 está presente um roteador
(HA) que oferece o serviço de agente domiciliar ao nó móvel. A rede com prefixo
2000:d::/64 é a rede que o nó móvel deve visitar.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nó} & \textbf{Interface} & \textbf{MAC} &
\textbf{Endereço} & \textbf{Tipo}\\ \hline \hline

% MN
& & & 2001:c::2 & Domiciliar (Global) \\ 
MN & eth0 & fe:fd:32:ff:42:c9 & 2001:c::fcfd:32ff:feff:42c9 & Auto-configurado\\
& & & 2001:d::fcfd:32ff:feff:42c9 & Care-of-address \\
& & & fe80::fcfd:32ff:feff:42c9 & Local \\ \hline

% CN
CN & eth0 & fe:fd:65:34:8a:44 & 2001:a::2 & Global \\
& & & fe80::fcfd:65ff:fe34:8a44 & Local \\ \hline

% HA
& eth0 & fe:fd:b0:a2:9a:4c & 2001:b::2 & Global \\ 
HA & & & fe80::fcfd:b0ff:fea2:9a4c & Local \\
& eth1 & fe:fd:f5:49:32:bc & 2001:c::1 & Global \\ 
& & & fe80::fcfd:f5ff:fe49:32bc & Local \\ \hline

%AR1
& eth0 & fe:fd:0d:0c:a2:22 & 2001:b::1 & Global \\ 
RA1 & & & fe80::fcfd:dff:fe0c:a222 & Local \\ 
& eth1 & fe:fd:ee:57:0a:cd & 2001:a::1 & Global \\
& & & fe80::fcfd:eeff:fe57:acd & Local \\ \hline

%AR2
& eth0 & fe:fd:9f:3d:cf:8a & 2000:b::3 & Global \\ 
RA2 & & & fe80::fcfd:9fff:fe3d:cf8a & Local \\ 
& eth1 & fe:fd:71:bf:e3:e1 & 2000:d::1 & Global \\
& & & fe80::fcfd:71ff:febf:e3e1 & Local \\ \hline
\end{tabular} 
\end{small}
\caption{Endereços do Cenário 1}
\label{t_addr1}
\end{table} 

\subsection{Variação 1: com Tunelamento Bidirecional e Sem Otimização de Rota}

\subsubsection{Análise da Troca de Mesagens}
Os dados obtidos na saída do comando \textit{tcpdump} foram compilados em forma
de uma tabela para facilitar a visualização dos mesmos e podem ser observados na
tabela \ref{t_resul_1}.
Analisando os dados recolhidos conseguimos observar o momento que o nó móvel
fez o movimento para a outra rede, no instante entre o echo reply seq 6 e o RA 
recebido do AR1.

\subsubsection{Análise das Tabelas de Roteamento e de Regras de Roteamento}

Podemos constatar mudanças nas tabelas de roteamento do nó móvel e do agente
domiciliar depois da mobilidade nas respecitivas tabelas \ref{t_rot_mn1} e
\ref{t_rot_ha1}. Após o agente domiciliar receber o \textit{Binding Update},
é adicionada a seguinte rota a sua tabela de roteamento, que todos os 
pacotes com destino ao endereço domiciliar devem ser encaminhados para o túnel.
Após o nó móvel receber o \textit{Router Advertisement}, é alterada a rota
padrão, deletada a rota para rede 2001:c::/64 e adicionada uma rota para a rede 
2001:d::/64, onde a interface eth0 está atrelada.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
 salto} & \textbf{Considerações} \\ \hline \hline
2001:a::/64 &	eth0	&	fe80::fcfd:dff:fe0c:a222 & \\
2001:b::/64 &   eth0	&	::  & \\
\textbf{2001:c::2} & \textbf{eth1} & \textbf{2001:c::2}  & Antes da mobilidade
do nó móvel\\
2001:c::/64 &	eth1	&	::  & \\
2001:d::/64 &	eth0	&	fe80::fcfd:9fff:fe3d:cf8a  & \\ \hline
2001:a::/64 &	eth0	&	fe80::fcfd:dff:fe0c:a222  & \\
2001:b::/64 &	eth0	&	::  & \\
\textbf{2001:c::2} & \textbf{ip6tnl1} & \textbf{2001:c::2} & Após a mobilidade
do nó móvel \\
2001:c::/64 &	eth1	&	::  & \\
2001:d::/64 &	eth0	&	fe80::fcfd:9fff:fe3d:cf8a  & \\ \hline
\end{tabular}
\end{small}
\caption{Tabela principal de roteamento do agente domiciliar}
\label{t_rot_ha1}
\end{table}

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto} & \textbf{Considerações}\\ \hline \hline
2001:c::2	          & ip6tnl1		  & :: &  \\
2001:c::/64               & eth0		  & :: & Na rede domiciliar \\
default	                  & eth0		  & fe80::fcfd:f5ff:fe49:32bc &
\\ \hline
2001:c::2	          & ip6tnl1		  & :: &  \\
2001:d::/64               & eth0		  & :: & Na rede visitada \\
default		          & eth0	          & fe80::fcfd:71ff:febf:e3e1 &
\\ \hline
\end{tabular} 
\end{small}
\caption{Tabela principal de roteamento do nó móvel}
\label{t_rot_mn1}
\end{table} 

Para que o nó móvel tenha os pacotes com destino ao nó correspondente e ao 
agente domiciliar encaminhados pelo túnel, o que caracteriza o tunelamento
bidirecional, é utilizado regras de roteamento, mostradas na tabela
\ref{t_rule_mn}.
As rotas da tabela 252 são mostradas na tabela \ref{t_route_252_mn}.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c||}\hline \hline
\textbf{Prioridade} & \textbf{Regra} & \textbf{Ação}
\\ \hline \hline
0:	& from all        &  lookup local \\
1001:	& from 2001:c::2  &  lookup 252 \\
1002:	& from fe80::/64 &   lookup main \\
1002:	& from 2001:d::/64 & lookup main \\
%1003:	& from 2001:c::2  &  blackhole\\
32766:	& from all        &  lookup main \\ \hline
\end{tabular} 
\end{small}
\caption{Regras de Roteamento do Nó movel}
\label{t_rule_mn}
\end{table} 

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c||}\hline \hline
\textbf{Prioridade} & \textbf{Regra} & \textbf{Ação}
\\ \hline \hline
0:	& from all        &  lookup local \\
1005:	& from 2001:c::2  &  lookup 252 \\
32766:	& from all        &  lookup main \\ \hline
\end{tabular} 
\end{small}
\caption{Regras de Roteamento do Home Agente}
\label{t_rule_ha}
\end{table} 


\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto} & \textbf{Considerações}\\ \hline \hline
          *                 &   *     &     *     &  Na rede domiciliar\\ \hline
2001:a::fcfd:65ff:fe34:8a44 & ip6tnl1 & 2001:a::fcfd:65ff:fe34:8a44 & \\
2001:c::1                   & ip6tnl1 & 2001:c::1 &  Na rede visitada\\
default                     & ip6tnl1 & ::        & \\ \hline
\end{tabular} 
\end{small}
\caption{Tabela de Roteamento 252 do nó móvel}
\label{t_route_252_mn}
\end{table}

A tabela de Roteamento 252 do agente domiciliar, após o nó móvel realizar a 
mobilidade, é adicionada a seguinte regra.

\begin{verbatim}
2001:c::2 from 2001:c::1 dev eth1  proto 16  metric 128  mtu 1500 advmss 
  1440 hoplimit 4294967295
\end{verbatim}

\subsubsection{Detalhes da Formação de Túneis}
O túnel no nó móvel é criado antes de acontecer qualquer mobilidade. No agente
domiciliar o  túnel com o nó móvel é criado no recebimento do BU. As tabelas 
\ref{t_tun_ha1} e \ref{t_tun_mn1} apresentam o endereçamento do tunel, no HA e 
MN, antes e depois da mobilidade.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} & \textbf{Considerações} \\ \hline \hline
ip6tnl1 & 2001:c::1 & 2001:c::2 & eth0 & Antes da mobilidade do nó móvel \\
 \hline
ip6tnl1 & 2001:c::1 & 2001:d::fcfd:32ff:feff:42c9 & eth0 & Após a mobilidade do 
nó móvel \\ \hline
\end{tabular}
\end{small}
\caption{Descrição dos \texttt{end-points} do tunel do nó móvel}
\label{t_tun_mn1}
\end{table}

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} & \textbf{Considerações} \\ \hline \hline
ip6tnl1 & :: & :: & eth0 & Antes da mobilidade do nó móvel \\ \hline
ip6tnl1 & 2001:d::fcfd:32ff:feff:42c9 & 2001:c::1 & eth0 & Após a mobilidade do 
nó móvel \\ \hline
\end{tabular}
\end{small}
\caption{Descrição dos \texttt{end-points} do tunel do agente domiciliar}
\label{t_tun_ha1}
\end{table}

%===========================================================================
\subsection{Variação 2: MIPv6 com Otimização de Rota}

\subsubsection{Análise da Troca de Mensagens}

\subsubsection{Estado das Tabelas de Roteamento e de Regras}

\subsubsection{Detalhes da Formação de Túneis}


%=========================================================================

\section{Cenário 2 - Uso do Protocolo HMIPv6}
\label{s_cenario2}

\subsection{Descrição da Topologia}
Com o fim de testar se a implementação experimental do HMIPv6 atende as
funcionalidades do protocolo o cenário 2 foi montando com os seguintes 
componentes (ver figura \ref{f_cenario2}):

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.3]{figs/cenario2}
	\caption{Topologia do Cenário 2}
 	\label{f_cenario2}
\end{figure}

\begin{itemize}
 \item Rede domiciliar com o prefixo 2001:e::/64 (\textit{Vlan} 1), onde estão o
agente domiciliar (HA) e o nó móvel (MN) no início do teste;
 \item Rede com o prefixo 2001:a::/64 (\textit{Vlan} 5), onde estão presentes um
roteador de acesso (RA1) e o nó correspondente (CN), que irá se comunicar com o
nó móvel durante o teste;
 \item Um domínio formado pelo MAP1,que executa o \textit{daemon} MIPL na função
de agente domiciliar, e um roteador de acesso (RA2). E as sub-redes com 
prefixos: 2001:c::/64 (\textit{Vlan} 3) e 2001:f::/64 (\textit{Vlan} 6);
 \item Um outro domínio formado pelo MAP2, que executa o \textit{daemon} MIPL na
função de agente domiciliar, e dois roteadores de acesso (RA3 e RA4), que
possibilitam o teste de mobilidade em um mesmo dominio. Sub-redes com os
prefixos: 2001:d::/64 (\textit{Vlan} 4), 2001:10::/64 (\textit{Vlan} 7) e
2001:11::/64 (\textit{Vlan} 8).
\end{itemize}

Os endereços atribuídos as interfaces dos nós, durante a realização do cenário,
bem como seus endereços de hardware estão disponíveis na tabela \ref{t_addr2}.

Durante a execução do cenário:
\begin{enumerate}
 \item O nó móvel iniciará na rede domiciliar se comunicando via \textit{ping6}
com o nó correspondente.
 \item Uma situação de mobilidade será ocasionada e o nó irá migrar para a
\textit{Vlan} 7, domínio do MAP2, caracterizando uma mobilidade global.
 \item Na segunda situação de mobilidade o nó irá migrar para a \textit{Vlan} 7
caracterizando uma mobilidade local.
 \item Podendo também ser feita uma mobilidade global para o domínio do MAP1
(\textit{Vlan} 6).
\end{enumerate}

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nó} & \textbf{Interface} & \textbf{MAC} &
\textbf{Endereço} & \textbf{Tipo}\\ \hline \hline

% MN
& & & 2001:c::2 & Domiciliar (Global) \\ 
MN & eth0 & fe:fd:32:ff:42:c9 & 2001:c::fcfd:32ff:feff:42c9 & Auto-configurado\\
& & & 2001:d::fcfd:32ff:feff:42c9 & Care-of-address \\
& & & fe80::fcfd:32ff:feff:42c9 & Local \\ \hline

% CN
CN & eth0 & fe:fd:65:34:8a:44 & 2001:a::2 & Global \\
& & & fe80::fcfd:65ff:fe34:8a44 & Local \\ \hline

% HA
& eth0 & fe:fd:b0:a2:9a:4c & 2001:b::2 & Global \\ 
HA & & & fe80::fcfd:b0ff:fea2:9a4c & Local \\
& eth1 & fe:fd:f5:49:32:bc & 2001:c::1 & Global \\ 
& & & fe80::fcfd:f5ff:fe49:32bc & Local \\ \hline

% MAP1
& eth0 & fe:fd:b0:a2:9a:4c & 2001:b::2 & Global \\ 
MAP1 & & & fe80::fcfd:b0ff:fea2:9a4c & Local \\
& eth1 & fe:fd:f5:49:32:bc & 2001:c::1 & Global \\ 
& & & fe80::fcfd:f5ff:fe49:32bc & Local \\ \hline

% MAP2
& eth0 & fe:fd:b0:a2:9a:4c & 2001:b::2 & Global \\ 
MAP2 & & & fe80::fcfd:b0ff:fea2:9a4c & Local \\
& eth1 & fe:fd:f5:49:32:bc & 2001:c::1 & Global \\ 
& & & fe80::fcfd:f5ff:fe49:32bc & Local \\ \hline

%AR1
& eth0 & fe:fd:0d:0c:a2:22 & 2001:b::1 & Global \\ 
RA1 & & & fe80::fcfd:dff:fe0c:a222 & Local \\ 
& eth1 & fe:fd:ee:57:0a:cd & 2001:a::1 & Global \\
& & & fe80::fcfd:eeff:fe57:acd & Local \\ \hline

%AR2
& eth0 & fe:fd:9f:3d:cf:8a & 2000:b::3 & Global \\ 
RA2 & & & fe80::fcfd:9fff:fe3d:cf8a & Local \\ 
& eth1 & fe:fd:71:bf:e3:e1 & 2000:d::1 & Global \\
& & & fe80::fcfd:71ff:febf:e3e1 & Local \\ \hline

%AR3
& eth0 & fe:fd:0d:0c:a2:22 & 2001:b::1 & Global \\ 
RA3 & & & fe80::fcfd:dff:fe0c:a222 & Local \\ 
& eth1 & fe:fd:ee:57:0a:cd & 2001:a::1 & Global \\
& & & fe80::fcfd:eeff:fe57:acd & Local \\ \hline

%AR4
& eth0 & fe:fd:9f:3d:cf:8a & 2000:b::3 & Global \\ 
RA4 & & & fe80::fcfd:9fff:fe3d:cf8a & Local \\ 
& eth1 & fe:fd:71:bf:e3:e1 & 2000:d::1 & Global \\
& & & fe80::fcfd:71ff:febf:e3e1 & Local \\ \hline
\end{tabular} 
\end{small}
\caption{Endereços do Cenário 2}
\label{t_addr2}
\end{table} 

\subsection{Análise da Troca de Mensagens}

\subsubsection{Mobilidade Global}
Durante a primeira situação de mobilidade do cenário 2, uma mobilidade global,
os dados coletados com a ferramenta \textit{tcpdump} estão disponíveis na figura
\ref{f_dump_inter}. Por meio deles pode-se observar que:

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.55]{figs/dump_inter}
	\caption{Cenário 2: \textit{Logs} Mobilidade Global}
 	\label{f_dump_inter}
\end{figure}

\begin{enumerate}
 \item Até esse momento o nó móvel estava na sua rede domiciliar recebendo 
\textit{echo request} do nó correspondente e mensagens RA do agente domiciliar.
Então é realizada a mobilidade e ele passa receber mensagens RA do roteador de
acesso RA3 com a opção de MAP propagada pelo MAP2.
 \item Realiza o DAD do LCoA gerado.
 \item Envia a mensagem de BU para o MAP2 com os seguintes campos:
\begin{itemize}
 \item Care-of-Address = LCoA;
 \item Endereço domiciliar = RCoA, gerado a partir da opção de MAP da mensagem
RA.
\end{itemize}
 \item Envia a mensagem de BU para o agente domiciliar com os seguintes campos:
\begin{itemize}
 \item CoA = RCoA;
 \item Endereço domiciliar = seu endereço domiciliar.
\end{itemize}
 \item Recebe a mensagem de BA do MAP2 como confirmação de registro bem
sucedido.
 \item Recebe a mensagem de BA do agente domiciliar, como confirmação de 
registro bem sucedido, via MAP2 de forma tunelada.
 \item Envia um \textit{echo reply} ao nó correspondente, com destino ao agente
domiciliar, com a mensagem tunelada ao nó correspondente, via MAP2. 
\end{enumerate}

\subsubsection{Mobilidade Local}
Na segunda situação de mobilidade do cenário 2, uma mobilidade local, as
mensagens trocadas pelo nó móvel estão disponíveis na figura \ref{f_dump_intra}.
Por meio delas pode-se observar que:

\begin{enumerate}
 \item É realizada a mobilidade e passa receber mensagens RA do roteador de
acesso RA4 ainda sobre cobertura do mesmo MAP.
 \item Realiza o DAD do novo LCoA gerado.
 \item Envia a mensagem de BU para o MAP2 com os seguintes campos:
\begin{itemize}
 \item Care-of-Address = LCoA;
 \item Endereço domiciliar = RCoA, gerado a partir da opção de MAP da mensagem
RA.
\end{itemize}
 Como é uma mobilidade local não é necessário enviar mensagem ao agente 
domiciliar.
 \item Recebe a mensagem de BA do MAP2 como confirmação de registro bem
sucedido.
 \item Recebe um \textit{echo reply} do nó correspondente, via MAP2 com a 
mensagem tunelada do agente domiciliar.
\end{enumerate}
\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.55]{figs/dump_intra}
	\caption{Cenário 2: \textit{Logs} Mobilidade Local}
 	\label{f_dump_intra}
\end{figure}

\subsection{Estado das Tabelas de Roteamento e de Regras}
Sobre as tabelas e as regras de roteamento a implementação do HMIpv6 não faz
nenhuma alteração. As tabelas de roteamento do cenário 2 se diferem muito pouco
das do cenário 1, tanto na mobilidade global e local. As tabelas 252
(\ref{t_c2_route_252}) e a principal (\ref{t_c2_route_main}) após a primeira
situação de mobilidade estão disponíveis logo abaixo. E seguem algumas
considerações sobre as regras e tabelas de roteamento do cenário 2:

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto}\\ \hline \hline
2001:a::fcfd:65ff:fe34:8a44 & ip6tnl1 & 2001:a::fcfd:65ff:fe34:8a44 \\
2001:e::1                   & ip6tnl1 & 2001:e::1\\
default                     & ip6tnl1 & :: \\ \hline
\end{tabular} 
\end{small}
\caption{Cenário 2: Tabela de Roteamento 252}
\label{t_c2_route_252}
\end{table}


\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c||}\hline \hline
\textbf{Destino} & \textbf{Via} & \textbf{Proximo
salto} \\ \hline \hline
2001:d::::fcfd:32ff:feff:42c9 & ip6tnl2		  & :: \\
2001:e::2	          & ip6tnl1		  & :: \\
2001:10::/64              & eth0		  & :: \\
default		          & eth0	          & fe80::fcfd:53ff:fe16:31aa \\
\hline
\end{tabular} 
\end{small}
\caption{Cenário 2: Tabela principal de roteamento}
\label{t_c2_route_main}
\end{table} 

\begin{itemize}
 \item antes da primeira situação de mobilidade as tabelas e regras de
roteamento do cenário 2 são iguais as cenário 1 antes da mobilidade;
 \item após a mobilidade:
\begin{itemize}
 \item as regras de roteamento são as mesmas que as do cenário com MIPv6;
 \item a tabela 252 se mantém a mesma que a do cenário com MIPv6.
 \item a rota padrão é alterada para o roteador de acesso AR3 e depois na
segunda situação de mobilidade para o roteador AR4;
 \item adicionada a rota que pacotes com destino ao RCoA são via ip6tnl2;
 \item as outras rotas se mantém as mesmas que as de um cenário com MIPv6.
\end{itemize}
\end{itemize}

\subsection{Detalhes da Formação de Túneis}
Os detalhes da formação dos túneis do cenário 2 diferem um pouco do cenário 1,
estas alterações feitas pela implementação são responsáveis pelo funcionamento
do HMIPv6. Nas tabelas \ref{t_tun_inter} e \ref{t_tun_intra} é possível ver os
túneis presentes no nó móvel após as mobilidades global e local. As principais
diferenças do cenário 1 são:

\begin{itemize}
 \item a criação do túnel entre o nó móvel e o MAP, com os pontos finais sendo o
LCoA e o endereço do MAP2;
 \item a alteração dos pontos finais do túnel entre o nó móvel e agente
domiciliar, RCoA e endereço agente domciliar, e a interface que este túnel
está ligado agora é o túnel entre nó móvel e MAP.
\end{itemize}

Os túneis dos MAP's e agente domiciliar se mantém iguais aos de um cenário
rodando o MIPv6.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} \\ \hline \hline
ip6tnl1 & 2001:e::1 & 2001:d::fcfd:32ff:feff:42c9 & ip6tnl2 \\
 \hline
ip6tnl2 & 2001:d::1 & 2001:10::fcfd:32ff:feff:42c9 & eth0  \\ \hline
\end{tabular}
\end{small}
\caption{Cenário 2: Túneis Mobilidade Global}
\label{t_tun_inter}
\end{table}

Após a mobilidade local verificamos que os dois túneis (ver \ref{t_tun_intra})
continuam presentes no nó móvel. Porém, o ponto local do túnel \textit{ip6tnl2}
foi alterado para o novo LCoA gerado na sub-rede do RA4.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|c|c||}\hline \hline
\textbf{Nome} & \textbf{Remoto} & \textbf{Local} & 
\textbf{Interface} \\ \hline \hline
ip6tnl1 & 2001:e::1 & 2001:d::fcfd:32ff:feff:42c9 & ip6tnl2 \\
 \hline
ip6tnl2 & 2001:d::1 & 2001:11::fcfd:32ff:feff:42c9 & eth0  \\ \hline
\end{tabular}
\end{small}
\caption{Cenário 2: Túneis Mobilidade Local}
\label{t_tun_intra}
\end{table}

\section{Análise dos Tempos de \textit{Handover}}
O tempo do handover é um dos maiores problemas do MIPv6, esta seção do trabalho
pretende fazer uma análise deste processo apontar as causas e possíveis
soluções. Como base para estudo dos tempos de \textit{handover} o cenário 1 com
tunelamento bidirecional foi utilizado.

Para verificar a perda na taxa de transmissão em um processo de
\textit{handover}, foi realizado o segundo teste especificado na seção sobre a
metodologia na realização dos cenários. Utilizando a ferramenta \textit{GNUPLOT}
com a saída do teste foi gerado o gráfico que pode ser observado na figura
\ref{f_banda}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/banda}
	\caption{Taxa de transmissão em \textit{Handover}}
	\label{f_banda}
\end{figure}

A partir  da figura é possível concluir que cada \textit{handover} é de
aproximadamente 3 segundos, há perdas consideráveis de pacotes que prejudicariam
muito comunicações interativas como videoconferência e \textit{VoIP}, porém,
navegação em páginas da \textit{Internet} e visualização de \textit{e-mail} a
instabilidade é tolerável.

Como cenário estudo foi simulado todos os tempos medidos são estimados. Porém,
segundo algumas bibliografias estudadas que realizaram experimentos fisicamente
os tempos medidos na simulação estão dentro do esperado.

Na tabela \ref{t_handover}, encontram-se os tempos das fases do processo de
\textit{handover} referentes ao cenário estudado.

\begin{table}[!htpb]
\centering
\begin{small}
  \setlength{\tabcolsep}{3pt}
\begin{tabular}{|c|c|c|}\hline
\textbf{Fase} & \textbf{Tempo (ms)} & \textbf{Media
\%} \\ \hline
\textit{TD} & 721 & 23,11 \\ \hline
\textit{TA} & 1371 & 43.92\\ \hline
\textit{TR} & 1029 & 32.97\\ \hline
\textit{TH} & 3121 & 100 \\ \hline
\end{tabular} 
\end{small}
\caption{Latência no \textit{Handover} do cenário estudado}
\label{t_handover}
\end{table} 

Algumas tentativas podem ser feitas para tentar diminuir a latência do
\textit{handover} nas fases de detecção de movimento e de configuração do
\textit{care-of-address}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/radvd}
	\caption{Diferentes intervalos entre as mensagens \textit{Router
Advertisement}}
	\label{f_radvd}
\end{figure}

Na tentativa de diminuir o tempo da fase de detecção de movimento, podemos
diminuir o intervalo entre as mensagens de \textit{Router Advertisement} do
roteador presente na rede que irá ser visitada pelo nó móvel. Pois, é por meio
desta mensagem que o nó móvel detecta o movimento e desencadeia o processo de
registro.

Para verificar se há uma melhora no processo de handover. O cenário
estudado foi repetido variando o intervalo entre as mensagens de
\textit{Router Advertisement}. O resultado deste teste esta disponível na figura
\ref{f_radvd}.

Com os dados levantados, é possível perceber que o intervalo entre as
mensagens de \textit{Router Advertisement} esta diretamente ligado com a perda
de pacotes durante o \textit{handover}. Porém, esta não é uma boa prática para
tentar amenizar a latência do handover, pois um numero muito grande de mensagen
\textit{multicasting} inundaria a rede prejudicando a perfomance principalmente
em redes sem fio.

No processo de formação de um novo \textit{care-of-address} o DAD é necessário
para se certificar que o endereço formado é exclusivo. Para o teste ser bem
sucedido nenhum nó vizinho deve enviar um \textit{Neighbor Advertisement}, em
resposta ao teste, ou \textit{Neighbor Solicitation}, como o mesmo endereço em
questão, em um período de \textit{1000ms} segundo a RFC 2462 \cite{rfc2462}.
Este tempo de espera compromete a fase de configuração do
\textit{care-of-address}.

\begin{figure}[!htpb]
	\centering
	\includegraphics[scale=.6]{figs/banda2}
	\caption{Taxa de transmissão em \textit{Handover} sem DAD e baixo
intervalo de RA}
	\label{f_banda2}
\end{figure}

Existe uma variável chamada \textit{dad\_transmits} no \textit{kernel} do Linux
que é usada para configurar o DAD em um nó. Com a intenção de diminuir a
latência na fase de configuração do \textit{care-of-address}, foi configurado a
variável com o valor 0, isso significa que o procedimento de DAD é cancelado, e
foi alterado o valor do intervalo das mensagens de \textit{Router Advertisement}
no roteador de acesso da rede visitada para 0.03 segundos. Então foi repetido o
teste. O resultado pode ser observado na figura \ref{f_banda2}.

Apartir, deste teste é possível perceber uma queda de 3 segundos para
aproximadamente 1 segundo no tempo do \textit{handover} com as mudanças
realizadas. Entretanto há um protocolo dedicado a acelerar o processo de
handover o \textit{Fast Handover} MIPv6. A idéia do FMIPv6 é providenciar
informação relativa à camada de rede, com o objetivo de prever ou responder
prontamente a um evento de handover \cite{rfc4068}.

\section{Conclusões sobre a Análise dos Cenários}
Com a realização dos experimentos podemos constatar o funcionamento do protocolo
e perceber continuação da comunicação entre os pontos comunicantes após a
mobilidade de forma transparente as camadas superiores a de rede, observar todas
as mensagens trocadas no processo e estimar o tempo de latência com a
mobilidade.

O primeiro resultado que se pode obter com a realização do Cenário 1, foi o
perfeito funcionamento do MIPv6, ocorreram algumas perdas de pacotes, mas o nó
móvel conseguiu continuar sendo alcançado pelo seu endereço domiciliar mesmo não
estando em sua rede domiciliar.

Na realização do cenário 2 foi possível verificar minimamente o funcionamento
do 
HMIPv6, claro que os problemas ainda existentes na implementação não permitiram
comprovar uma melhora no \textit{handover}. Porém, pode-se ver um
avanço já que não tinhamos nenhuma versão recente deste protocolo.

Com a realização dos cenários é possível verificar que o \textit{handover} é o
é o grande problema MIPv6, por isso, a necessidade de outras extensões para
trabalharem juntos com o MIPv6 como: o HMIPv6 e FMIPv6.